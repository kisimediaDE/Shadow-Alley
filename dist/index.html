<!doctype html> <html lang="de"> <head> <meta charset="utf-8"> <meta content="width=device-width,initial-scale=1" name="viewport"> <title>Shadow Alley – Mini‑Prototyp</title> <style>#hud,.hint{opacity:.8}#tutorial,.kbd{background:#0f1320}body,html{height:100%;margin:0;background:#0b0d12;color:#dbe0ea;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}.wrap{display:grid;place-items:center;height:100%;gap:12px}canvas{background:#121621;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.04)}.hint{font-size:14px}.kbd{padding:2px 6px;border:1px solid #384152;border-bottom-width:2px;border-radius:6px;color:#c7cee0}a{color:#9ec5ff;text-decoration:none}#hud{width:100%;text-align:center;font:14px system-ui,sans-serif;color:#dbe0ea;pointer-events:none;margin-bottom:4px}#tutorial{border:1px solid #384152;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.04);padding:12px;opacity:0}</style> </head> <body> <div class="wrap"> <div id="hud"> Level: <span class="kbd" id="levelCount"></span> · Fische: <span class="kbd" id="fishCount"></span> · <span id="doorState"></span> </div> <canvas aria-label="Shadow Alley" height="320" id="game" width="480"></canvas> <div class="hint" id="tutorial"></div> <div class="hint" id="levelSelectWrapper" style="margin-top:6px;text-align:center"> <label for="levelSelect">Level auswählen:</label> <select class="kbd" id="levelSelect" style="min-width:140px"></select> </div> <div class="hint"> Steuerung: <span class="kbd">WASD</span>/<span class="kbd">Pfeile</span> · Neustart: <span class="kbd">R</span> · Ton: <span class="kbd">M</span> </div> </div> <script>const LEVELS=["##############################\n#............f............x..#\n#..####....####.......####...#\n#..#..#................#.....#\n#..#..#................#.....#\n#..####................#.....#\n#............................#\n#.####..####..####..####.....#\n#............................#\n#............................#\n#..........####..............#\n#..........#..#..............#\n#..........#..#..............#\n#..####....####..####..####..#\n#..#..#..................#...#\n#..#..#..................#...#\n#..####..................#...#\n#c...........................#\n#..f.........................#\n##############################","##############################\n#....l.......f...............#\n#......####...........####...#\n#.....................#..#...#\n#.........####........#..#...#\n#.....................#..#...#\n#..##.........l.......####...#\n#............................#\n#............f...............#\n#..l.....####............l...#\n#........#..#..............###\n#.######.#..#...........#....#\n#........####...........#....#\n#.......................#....#\n#..............l........#....#\n#...........#...........#....#\n#...........#...........#....#\n#c..........#......f....#....#\n#...........#...........#.x..#\n##############################","##############################\n#....l..........f...l........#\n#............................#\n#.x.....####.................#\n#.......................####.#\n#...####......####...........#\n#........l........####.......#\n#.................#..#.......#\n#......f..........#..#.......#\n#.................####...l...#\n#............................#\n#....L......###...........f..#\n#.####........#..............#\n#.#..#........#..........#####\n#.#..#...................#...#\n#.####........L..........#...#\n#........................#...#\n#c.......................#...#\n#...................f....#...#\n##############################","##############################\n#..s.l..s..L..f..s..l..s..x..#\n#..####s..####s.....s####..s.#\n#s.#..#....s.........#...s...#\n#..#..#.s....L....s..#..s....#\n#..####..s........s..#..s....#\n#..s.....l....s.......s......#\n#.####..####..####..####.s...#\n#....f......s...............s#\n#..s.....s.......l.....s.....#\n#..........####...........s..#\n#....L..s..#..#..s...........#\n#..s.......#..#.......s......#\n#..####.s..####..####....#####\n#..#..#....................#.#\n#s.#..#....s...............#.#\n#..####..s.........f.......#.#\n#c...s...s...s...........#...#\n#..f......s......l....s......#\n##############################"],TIPS=["Sammle alle Fische und gehe zur Tür.","Achte auf feste Lampen – bleib im Schatten, sammle alle Fische und zur Tür.","Bewegliche Wachen mit Lichtkegeln – Timing! Fische sammeln und zur Tür.","Nutze die Verstecke (bläuliche Patches), meide Lichtkegel, sammle alle Fische und zur Tür."]</script> <script>function e(){if(k){k.innerHTML="";for(let e=0;e<LEVELS.length;e++){const t=document.createElement("option");t.value=e,t.textContent=`Level ${e+1}`,e>A.unlocked&&(t.disabled=1),e===R&&(t.selected=1),k.appendChild(t)}}}function t(e,t,l){return Math.max(t,Math.min(l,0|e))}function l(){try{localStorage.setItem(I,JSON.stringify(A))}catch(e){}}function n(){const e=LEVELS.length-1,t=Math.min(R+1,e);A.unlocked<t&&(A.unlocked=t,l())}function a(e){w.length=V.length=C.length=L.length=E.length=0,Y=0,H=0,D=0,e.split("\n").forEach((e,t)=>{for(let l=0;l<e.length;l++){const n=e[l],a=l*v,o=t*v;if("#"==n)w.push({x:a,y:o,w:v,h:v});else if("s"==n)V.push({x:a,y:o,w:v,h:v,glowIntensity:0});else if("l"==n)C.push({x:a+8,y:o+8,range:120,fov:Math.PI/3,angle:0,offX:10,offY:-11});else if("L"==n){const e=["#cc4455","#4aa3ff","#7bd389","#f2b134"],t=e[Math.floor(Math.random()*e.length)];L.push({x:a+8,y:o+8,range:160,fov:Math.PI/2,angle:0,dir:1,sweep:.9,accent:t})}else"f"==n?E.push({x:a+8,y:o+8,t:1,dir:.5>Math.random()?0:Math.PI,p:6.28*Math.random(),anim:0,cycle:1.5+3*Math.random()}):"x"==n?q={x:a,y:o,w:v,h:v}:"c"==n&&(G.x=a+8,G.y=o+8)}}),X=E.length}function o(){n();const t=LEVELS.length-1;R=t>R?Math.min(A.unlocked,t):t,A.current=R,l(),a(LEVELS[R]),_=0,U=0,D=0,H=0,j=null,e()}function i(e,t,l){return t>e?t:e>l?l:e}function r(e,t,l){return!(e<l.x||e>l.x+l.w||t<l.y||t>l.y+l.h)}function c(e,t,l){for(let n=0;n<l.length;n++)if(r(e,t,l[n]))return 1;return 0}function s(e,t){return c(e,t,V)}function f(e,t,l,n,a,o,i){const r=e-l,S=t-n;if(Math.hypot(r,S)>i)return 0;const c=Math.atan2(S,r),s=Math.atan2(Math.sin(c-a),Math.cos(c-a));return Math.abs(s)<=.5*o}function h(e,t){for(const l of C)if(f(e,t,l.x+(l.offX||0),l.y+(l.offY||0),0,l.fov,l.range))return 1;for(const l of L)if(f(e,t,l.x,l.y,l.angle,l.fov,l.range))return 1;return 0}function u(){if(ee)return;ee=1,K=new(window.AudioContext||window.webkitAudioContext),Z=K.createGain(),Z.gain.value=te?0:.7,Z.connect(K.destination),le=K.createGain(),le.gain.value=.05,re=K.createStereoPanner(),re.pan.value=0,le.connect(re).connect(Z);const e=d(1),t=K.createBiquadFilter();t.type="lowpass",t.frequency.value=700,t.Q.value=1e-4;const l=K.createBiquadFilter();l.type="lowshelf",l.frequency.value=180,l.gain.value=8;const n=K.createBiquadFilter();n.type="highshelf",n.frequency.value=1500,n.gain.value=-24;const a=K.createGain();a.gain.value=.9,e.connect(t).connect(l).connect(n).connect(a).connect(le);const o=d(1),i=K.createBiquadFilter();i.type="bandpass",i.frequency.value=900,i.Q.value=.8;const r=K.createBiquadFilter();r.type="highshelf",r.frequency.value=1500,r.gain.value=-12;const S=K.createGain();S.gain.value=.35,o.connect(i).connect(r).connect(S).connect(le),ne=K.createOscillator(),ne.frequency.value=.5,ae=K.createGain(),ae.gain.value=.04,ne.connect(ae).connect(le.gain),oe=K.createOscillator(),oe.frequency.value=.12,ie=K.createGain(),ie.gain.value=.18,oe.connect(ie).connect(re.pan);const c=K.currentTime;e.start(c),o.start(c),ne.start(c),oe.start(c),(()=>{if(!K||ce)return;fe=K.createGain(),fe.gain.value=.05,se=K.createGain(),se.gain.value=0,ce=K.createOscillator(),ce.type="triangle",ce.frequency.value=440,ce.connect(se).connect(fe).connect(Z);const e=K.currentTime;ce.start(e);const t=[440,523.25,587.33,659.25,783.99,880];!function e(){!function(){if(!K)return;const e=K.currentTime;ue=(()=>{if(.72>Math.random()){const e=[-1,0,1][Math.floor(3*Math.random())];let l=ue+e;return l=Math.max(0,Math.min(t.length-1,l)),l}return Math.floor(Math.random()*t.length)})();const l=t[ue]*(.08>Math.random()?.5:1);ce.frequency.cancelScheduledValues(e),ce.frequency.setValueAtTime(ce.frequency.value,e),ce.frequency.exponentialRampToValueAtTime(Math.max(60,l),e+.12),se.gain.cancelScheduledValues(e),se.gain.setValueAtTime(0,e),se.gain.linearRampToValueAtTime(.12,e+.04),se.gain.exponentialRampToValueAtTime(1e-4,e+.35)}();const l=.6+.2*Math.random();he=setTimeout(e,1e3*l)}()})()}function d(e=0){const t=(K||new(window.AudioContext||window.webkitAudioContext)).createBuffer(1,Math.floor(44100),44100),l=t.getChannelData(0);for(let e=0;e<l.length;e++)l[e]=.6*(2*Math.random()-1);const n=K.createBufferSource();return n.buffer=t,n.loop=!!e,n}function y(e,t){const l=e.range,n=e.fov,a=t?0:e.angle,o=t&&null!=e.offX?e.x+e.offX:e.x,i=t&&null!=e.offY?e.y+e.offY:e.y,r=a-n/2,c=a+n/2,s=S.createRadialGradient(o,i,8,o,i,l);s.addColorStop(0,"rgba(255,220,120,0.45)"),s.addColorStop(.7,"rgba(255,210,110,0.18)"),s.addColorStop(1,"rgba(255,200,100,0.0)"),S.save(),S.fillStyle=s,S.beginPath(),S.moveTo(o,i),S.lineTo(o+Math.cos(r)*l,i+Math.sin(r)*l),S.arc(o,i,l,r,c),S.closePath(),S.fill(),S.restore()}function g(e){const{x:t,y:l,dir:n,p:a,anim:o}=e,i=J,r=1+1.2*o,c=Math.sin(7*i+(a||0))*(.7*r),s=Math.sin(1.6*i+(a||0))*(.9*(.5+.5*r)),f=Math.sin(2.2*i+1.3*(a||0))*(.05*r),h=1+f,u=1-.7*f;S.save();const d=S.createRadialGradient(t,l,0,t,l,10);d.addColorStop(0,"rgba(255,214,102,0.16)"),d.addColorStop(1,"rgba(255,214,102,0)"),S.fillStyle=d,S.fillRect(t-12,l-12,24,24),S.restore(),S.save(),S.translate(t,l+s);const y=n&&.001>Math.abs(n-Math.PI);S.scale((y?-1:1)*h,u),S.fillStyle="#ffd166",S.beginPath(),S.ellipse(0,0,9*.6,3,0,0,2*Math.PI),S.fill(),S.strokeStyle="rgba(50,60,80,0.35)",S.lineWidth=.8,S.stroke(),S.fillStyle="#eab54a",S.beginPath(),S.moveTo(.6*-9,0),S.lineTo(.6*-9-3.5,2+c),S.lineTo(.6*-9-3.5,-2-c),S.closePath(),S.fill(),S.fillStyle="#f6c255",S.save(),S.translate(1.2,-2.25),S.rotate(.1*c),S.beginPath(),S.moveTo(-2.2,0),S.lineTo(1.8,-3),S.lineTo(3.2,0),S.closePath(),S.fill(),S.restore(),o>.05&&(S.fillStyle="rgba(80,70,60,0.25)",S.beginPath(),S.ellipse(-1.5,.2,1.2*(1+.6*o),1,0,0,2*Math.PI),S.fill()),S.fillStyle="#4b4f5a",S.beginPath(),S.arc(9*.28,-.4,.7,0,2*Math.PI),S.fill(),S.globalAlpha=.28+.22*o,S.fillStyle="#ffffff",S.beginPath(),S.ellipse(.45,-1.25,2,1,0,0,2*Math.PI),S.fill(),S.globalAlpha=1,S.restore()}function m(e){const{x:t,y:l,angle:n,accent:a}=e,o=J;S.save(),S.translate(t,l),S.rotate(n);const i=.72;S.fillStyle="rgba(0,0,0,0.35)",S.beginPath(),S.ellipse(0,6*i,8*i,2.6*i,0,0,2*Math.PI),S.fill();const r="#4f4436",c=a||"#cc4455";S.fillStyle=r,S.beginPath(),S.ellipse(-1*i,0,9*i,6*i,0,0,2*Math.PI),S.fill(),S.fillStyle="#3f362c",S.beginPath(),S.ellipse(-2*i,2.6*i,4.608,2.6*i,0,0,2*Math.PI),S.fill();const s=3.8*i,f=2.5*i;S.fillStyle=r,S.beginPath(),S.ellipse(s,-.72,2.592,f,0,0,2*Math.PI),S.fill(),S.strokeStyle=c,S.lineWidth=.864,S.beginPath(),S.ellipse(s,-.648,2.4624,.99,0,0,2*Math.PI),S.stroke(),S.fillStyle="#ffd166",S.beginPath(),S.arc(s-.2*2.592,.72,.648,0,2*Math.PI),S.fill(),S.fillStyle=r,S.beginPath(),S.ellipse(7.6*i,-1.584,3.312,2.592,0,0,2*Math.PI),S.fill(),S.fillStyle="#c7ab92",S.beginPath(),S.moveTo(6.912,-3*i),S.lineTo(9.072,-2.016),S.lineTo(9.072,-.864),S.lineTo(6.912,-1.3*i),S.closePath(),S.fill(),S.beginPath(),S.ellipse(12.7*i,-2*i,1*i,1*i,0,0,2*Math.PI),S.fill(),S.fillStyle="#1b1f28",S.beginPath(),S.arc(9.648,-2*i,.54,0,2*Math.PI),S.fill();const h=.18*Math.sin(5.2*o)*i;S.fillStyle=r,S.beginPath(),S.moveTo(4.752,-5.2*i),S.lineTo(5.616,-5.688-h),S.lineTo(9*i,-5*i),S.closePath(),S.fill(),S.globalAlpha=.85,S.beginPath(),S.moveTo(4.104,-3.528),S.lineTo(4.968,-7.3*i+.6*h),S.lineTo(7.6*i,-3.384),S.closePath(),S.fill(),S.globalAlpha=1,S.fillStyle="#12151b",S.beginPath(),S.arc(7.056,-3*i,.432,0,2*Math.PI),S.fill();const u=2.304,d=Math.sin(4.8*o);S.fillStyle=r,S.fillRect(3.168,u+-.2*d*i,1.152,2.592),S.fillRect(6.2*i,u+.2*d*i,1.152,2.592),S.fillRect(-3.888,u+.2*d*i,1.296,3.8*i),S.fillRect(-2.448,u+-.2*d*i,1.296,3.8*i);const y=.5*Math.sin(9.5*o)*i;S.strokeStyle=r,S.lineWidth=2,S.beginPath(),S.moveTo(-9*i,-.432),S.quadraticCurveTo(-8.352,-4*i+y,-6.048,-4.896+y),S.stroke(),S.restore()}function p(e){const{x:t,y:l}=e;S.save(),S.fillStyle="rgba(0,0,0,0.25)",S.beginPath(),S.ellipse(t,l+8,6,2,0,0,2*Math.PI),S.fill(),S.fillStyle="#2a3140",S.fillRect(t-1,l-12,2,16),S.fillRect(t+0,l-10,8,2);const n=t+(e.offX??10),a=l+(e.offY??-11);S.fillStyle="#232a38",S.fillRect(n-5,a-3,10,6),S.fillStyle="#1d2330",S.fillRect(n-4,a-5,8,2),S.fillStyle="rgba(255,236,170,0.9)",S.fillRect(n-4,a-2,8,4),S.fillStyle="#1d2330",S.fillRect(n-1,a-6,2,1),S.fillStyle="#2a3140",S.fillRect(t-3,l+3,6,2);const o=n+2,i=a,r=S.createRadialGradient(o,i,2,o,i,26);r.addColorStop(0,"rgba(255,236,170,0.35)"),r.addColorStop(1,"rgba(255,236,170,0.0)"),S.fillStyle=r,S.fillRect(n-26,a-26,52,52),S.restore()}function b(e){function t(){return y=1e4*Math.sin(y),y-Math.floor(y)}const l=e.x,n=e.y,a=e.w,o=e.h,i=J||0;S.save(),S.fillStyle="rgba(8,14,24,0.78)",S.fillRect(l,n,a,o);const r=l+.5*a,c=n+.5*o,s=S.createRadialGradient(r,c,2,r,c,.75*Math.max(a,o));s.addColorStop(0,"rgba(0,0,0,0.38)"),s.addColorStop(.65,"rgba(0,0,0,0.2)"),s.addColorStop(1,"rgba(0,0,0,0)"),S.fillStyle=s,S.fillRect(l-8,n-8,a+16,o+16);let f=S.createLinearGradient(l,n,l,n+7);f.addColorStop(0,"rgba(0,0,0,0.65)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),S.fillStyle=f,S.fillRect(l,n,a,7),f=S.createLinearGradient(l,n+o,l,n+o-7),f.addColorStop(0,"rgba(0,0,0,0.55)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),S.fillStyle=f,S.fillRect(l,n+o-7,a,7),f=S.createLinearGradient(l,n,l+7,n),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),S.fillStyle=f,S.fillRect(l,n,7,o),f=S.createLinearGradient(l+a,n,l+a-7,n),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),S.fillStyle=f,S.fillRect(l+a-7,n,7,o),S.strokeStyle="rgba(120,170,220,0.12)",S.lineWidth=1,S.strokeRect(l+.5,n+.5,a-1,o-1),S.globalAlpha=.08,S.fillStyle="#5f6d85";const u=l/a|0,d=n/o|0;let y=1e4*Math.sin(91*(u+31)+57*(d+17)+.8*i);for(let e=0;8>e;e++){const e=l+Math.floor(t()*a),i=n+Math.floor(t()*o);S.fillRect(e,i,1,1)}S.globalAlpha=1;const g=l+.5*a,m=n+.5*o,p=h(g,m)?1:0;if("number"!=typeof e.glowIntensity&&(e.glowIntensity=0),e.glowIntensity+=.08*(p-e.glowIntensity),e.glowIntensity>.01){const t=.18*(.6+.4*(.5+.5*Math.sin(1.6*(J||0))))*e.glowIntensity,i=S.createRadialGradient(g,m,2,g,m,1.2*Math.max(a,o));i.addColorStop(0,`rgba(120,170,255,${t})`),i.addColorStop(1,"rgba(120,170,255,0)"),S.fillStyle=i,S.fillRect(l-12,n-12,a+24,o+24)}S.restore()}function T(e,t,l){S.fillStyle="rgba(0,0,0,0.6)",S.fillRect(0,0,P,x),S.textAlign="center",S.fillStyle=e,S.font="bold 24px system-ui, sans-serif",S.fillText(t,P/2,x/2-6),S.fillStyle="#dbe0ea",S.font="14px system-ui, sans-serif",S.fillText(l,P/2,x/2+16),S.textAlign="left"}const M=document.getElementById("game"),S=M.getContext("2d"),P=M.width,x=M.height,v=16;Math.floor(P/v),Math.floor(x/v);let R=0;const k=document.getElementById("levelSelect");k&&k.addEventListener("change",()=>{const t=parseInt(k.value,10);Number.isNaN(t)||t>A.unlocked||(R=t,A.current=t,l(),a(LEVELS[R]),_=0,U=0,D=0,H=0,j=null),e()});const I="sa_progress_v1";let A={current:0,unlocked:0},w=[],V=[],C=[],L=[],E=[],q={x:P-32,y:16,w:v,h:v};const G={x:64,y:x-64,r:6,speed:1.7,vx:0,vy:0,dir:"R",step:0,state:"idle",idle:0,blink:1,blinkTimer:2,fpTimer:0,pawParity:0,db:0},B=[],W=[],F=[],O=[{x:80,y:60,dx:.06,dy:.02,r:90,a:.12},{x:240,y:140,dx:-.04,dy:.03,r:120,a:.1},{x:380,y:220,dx:.03,dy:-.05,r:100,a:.09}];let N=0;const $=[];let X=0,Y=0,D=0,H=0;(()=>{try{const e=localStorage.getItem(I);if(e){const t=JSON.parse(e);"object"==typeof t&&t&&(A={current:0|t.current,unlocked:0|t.unlocked})}}catch(e){}const e=LEVELS.length-1;A.unlocked=t(A.unlocked,0,e),A.current=t(A.current,0,A.unlocked)})(),R=t(A.current,0,Math.max(0,Math.min(A.unlocked,LEVELS.length-1))),a(LEVELS[R]),e();const Q=Object.create(null);addEventListener("keydown",t=>{Q[t.key]=1,ee||u(),"m"!==t.key&&"M"!==t.key||(te=!te,Z&&(Z.gain.value=te?0:.7)),"r"!==t.key&&"R"!==t.key||(a(LEVELS[R]),_=0,U=0,G.vx=G.vy=0,A.current=R,l(),e()),"n"!==t.key&&"N"!==t.key||!H||o()}),addEventListener("keyup",e=>Q[e.key]=0);let j=null,z=performance.now(),J=0,_=0,U=0,K=null,Z=null,ee=0,te=0,le=null,ne=null,ae=null,oe=null,ie=null,re=null,ce=null,se=null,fe=null,he=null,ue=0,de=0;const ye={collect(){if(!K)return;const e=K.currentTime,t=K.createGain();t.gain.setValueAtTime(0,e),t.gain.linearRampToValueAtTime(.25,e+.005),t.gain.exponentialRampToValueAtTime(1e-4,e+.18);const l=K.createOscillator();l.type="sine",l.frequency.setValueAtTime(880,e),l.frequency.exponentialRampToValueAtTime(1320,e+.12);const n=K.createOscillator();n.type="sine",n.frequency.setValueAtTime(660,e+.02),n.frequency.exponentialRampToValueAtTime(990,e+.18),l.connect(t),n.connect(t),t.connect(Z),l.start(e),l.stop(e+.2),n.start(e+.02),n.stop(e+.22)},door(){if(!K)return;const e=K.currentTime,t=d(),l=K.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.2,e+.05),l.gain.exponentialRampToValueAtTime(1e-4,e+.6);const n=K.createBiquadFilter();n.type="bandpass",n.frequency.value=1200,n.Q.value=.8,t.connect(n).connect(l).connect(Z),t.start(e),t.stop(e+.65);const a=K.createOscillator();a.type="sine",a.frequency.setValueAtTime(180,e),a.frequency.exponentialRampToValueAtTime(90,e+.5);const o=K.createGain();o.gain.setValueAtTime(0,e),o.gain.linearRampToValueAtTime(.12,e+.1),o.gain.exponentialRampToValueAtTime(1e-4,e+.6),a.connect(o).connect(Z),a.start(e),a.stop(e+.65)},alert(){if(!K)return;const e=K.currentTime,t=K.createOscillator();t.type="square",t.frequency.setValueAtTime(340,e),t.frequency.exponentialRampToValueAtTime(160,e+.08);const l=K.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.28,e+.005),l.gain.exponentialRampToValueAtTime(1e-4,e+.15),t.connect(l).connect(Z),t.start(e),t.stop(e+.16);const n=d(),a=K.createGain();a.gain.setValueAtTime(.2,e),a.gain.exponentialRampToValueAtTime(1e-4,e+.06),n.connect(a).connect(Z),n.start(e),n.stop(e+.08)},footstep(e){if(!K)return;const t=K.currentTime,l=K.createBuffer(1,Math.floor(.05*K.sampleRate),K.sampleRate),n=l.getChannelData(0);for(let e=0;e<n.length;e++){const t=Math.exp(-e/180),l=.5*(2*Math.random()-1);n[e]=l*t}const a=K.createBufferSource();a.buffer=l;const o=K.createBiquadFilter();o.type="lowpass",o.frequency.value=1100+200*Math.random();const i=K.createBiquadFilter();i.type="highshelf",i.frequency.value=2e3,i.gain.value=-10;const r=K.createGain(),S=.16+.05*Math.random();r.gain.value=e?.55*S:S,a.connect(o).connect(i).connect(r).connect(Z),a.start(t)},success(){if(!K)return;const e=K.currentTime;[523.25,659.25,783.99].forEach(t=>{const l=K.createOscillator();l.type="sine",l.frequency.value=t;const n=K.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.15,e+.02),n.gain.exponentialRampToValueAtTime(1e-4,e+.25),l.connect(n).connect(Z),l.start(e),l.stop(e+.3)})}};requestAnimationFrame(function e(t){const a=(t-z)/1e3;z=t,J+=a,(e=>{if(D||H)return H&&null!=j&&J>=j?void o():void 0;let t=0,a=0;if((Q.ArrowLeft||Q.a||Q.A)&&(t-=1),(Q.ArrowRight||Q.d||Q.D)&&(t+=1),(Q.ArrowUp||Q.w||Q.W)&&(a-=1),(Q.ArrowDown||Q.s||Q.S)&&(a+=1),t||a){const e=Math.hypot(t,a);t/=e,a/=e}const S=60*G.speed*e;let h=i(G.x+t*S,G.r+1,P-G.r-1);c(h,G.y,w)||(G.x=h),h=i(G.y+a*S,G.r+1,x-G.r-1),c(G.x,h,w)||(G.y=h),-.01>t?G.dir="L":t>.01&&(G.dir="R"),t||a?G.step+=8*e:G.step=0;const u=!(!t&&!a),d=s(G.x,G.y);if(u?(G.idle=0,G.state=d?"crouch":"walk"):(G.idle+=e,d?G.state="crouch":G.idle>.8?G.state="sit":G.state="idle"),G.blinkTimer-=e,G.blinkTimer>0||(G.blink>.5?(G.blink=0,G.blinkTimer=.1):(G.blink=1,G.db?(G.db=0,G.blinkTimer=1.8+2.2*Math.random()):.25>Math.random()&&"walk"!==G.state?(G.db=1,G.blinkTimer=.2):G.blinkTimer=1.8+2.2*Math.random())),(t||a)&&(G.fpTimer-=e,0>=G.fpTimer)){const e=Math.hypot(t,a)||1,l=t/e,n=a/e,o=G.pawParity?1:-1,i=G.x-6*l+3*-n*o,r=G.y-6*n+3*l*o;if(B.push({x:i,y:r,life:1}),G.fpTimer=.14,G.pawParity^=1,ee&&K){const e=K.currentTime;if((t||a)&&e-de>.25){const t=s(G.x,G.y);ye.footstep(t),de=e}}}for(let t=B.length-1;t>=0;t--)B[t].life-=.35*e,B[t].life>0||B.splice(t,1);for(const t of E)if(t.t){if(t.cycle-=e,0>=t.cycle){t.anim=1,t.cycle=1.8+2.8*Math.random(),.2>Math.random()&&(t.dir=0===t.dir?Math.PI:0);for(let e=0;3>e;e++){const e=(0===t.dir?1:-1)*(3.5+Math.random()),l=1*Math.random()-.5;$.push({x:t.x+e,y:t.y+l,vy:-20-15*Math.random(),life:.9})}}t.anim>0&&(t.anim=Math.max(0,t.anim-1.5*e))}for(let t=$.length-1;t>=0;t--){const l=$[t];l.y+=l.vy*e,l.life-=.7*e,l.life>0&&l.y>=0||$.splice(t,1)}if(N-=e,0>=N){for(let e=0;3>e;e++){const e=Math.random()*P,t=-10-40*Math.random(),l=220+80*Math.random(),n=-60-40*Math.random();W.push({x:e,y:t,vx:n,vy:l,len:10+8*Math.random()})}N=.05/.3}for(let t=W.length-1;t>=0;t--){const l=W[t];l.x+=l.vx*e,l.y+=l.vy*e,l.y>x-18?(F.push({x:l.x,y:x-18,life:1}),W.splice(t,1)):(-20>l.x||l.x>P+20||l.y>x+20)&&W.splice(t,1)}for(let t=F.length-1;t>=0;t--)F[t].life-=1.8*e,F[t].life>0||F.splice(t,1);for(const e of O)e.x+=e.dx,e.y+=e.dy,e.x<-e.r?e.x=P+e.r:e.x>P+e.r&&(e.x=-e.r),e.y<-e.r?e.y=x+e.r:e.y>x+e.r&&(e.y=-e.r);for(const t of L)t.angle+=t.dir*t.sweep*e,t.angle>1&&(t.angle=1,t.dir=-1),-1>t.angle&&(t.angle=-1,t.dir=1);const y=s(G.x,G.y);let g=0;for(const e of C)if(f(G.x,G.y,e.x+(e.offX||0),e.y+(e.offY||0),0,e.fov,e.range)){g=1;break}if(!g)for(const e of L)if(f(G.x,G.y,e.x,e.y,e.angle,e.fov,e.range)){g=1;break}g&&!y&&(!D&&ee&&ye.alert(),D=1);for(const e of E)e.t&&8>Math.hypot(G.x-e.x,G.y-e.y)&&(e.t=0,Y++,ee&&ye.collect());Y!==X||_||(ee&&ye.door(),_=1),Y===X&&r(G.x,G.y,q)&&(H||(H=1,ee&&!U&&(ye.success(),U=1),null==j&&(j=J+1.2),n(),A.current=Math.min(A.unlocked,LEVELS.length-1),l()))})(a),(()=>{const e=LEVELS.length-1;A.unlocked>e&&(A.unlocked=e),R>A.unlocked&&(R=A.unlocked),A.current!==R&&(A.current=R,l()),S.clearRect(0,0,P,x);const t=S.createLinearGradient(0,0,0,x);t.addColorStop(0,"#0f1420"),t.addColorStop(1,"#0b0e17"),S.fillStyle=t,S.fillRect(0,0,P,x),S.fillStyle="rgba(0,0,0,0.0)",S.fillRect(0,0,P,x),S.fillStyle="#0b0d12";for(const e of w)S.fillRect(e.x,e.y,e.w,e.h);for(const e of V)b(e);const n=Y===X;((e,t,l,n,a)=>{const o=e+l/2,i=t+n/2;if(S.save(),S.fillStyle="#0b0d12",S.fillRect(e,t,l,n),S.fillStyle="#141a22",S.fillRect(e+1,t+1,l-2,n-2),a){const a=2,r=e+a,c=t+a,s=l-2*a,f=n-2*a;S.fillStyle="#0a0f14",S.fillRect(r,c,s,f);const h=S.createRadialGradient(o,i,2,o,i,Math.max(l,n));h.addColorStop(0,"rgba(95,208,138,0.35)"),h.addColorStop(1,"rgba(95,208,138,0)"),S.fillStyle=h,S.fillRect(e-8,t-8,l+16,n+16),S.fillStyle="rgba(95,208,138,0.22)",S.beginPath();const u=o-.25*s,d=o+.25*s;S.moveTo(u,t+n),S.lineTo(d,t+n),S.lineTo(d+4,t+n+5),S.lineTo(u-4,t+n+5),S.closePath(),S.fill(),S.fillStyle="#23323b",S.strokeStyle="rgba(200,210,230,0.1)",S.lineWidth=1,S.beginPath();const y=r+.15*s,g=c+1;S.moveTo(y,g),S.lineTo(y+.55*s,g+.1*f),S.lineTo(y+.55*s,g+f-1),S.lineTo(y,g+f-2),S.closePath(),S.fill(),S.stroke();const m=.5*(Math.sin(3*J)+1),p=Math.max(1.5,3+3*m);S.fillStyle="#5fd08a",S.fillRect(o-p/2,c+2,p,f-4),S.strokeStyle="rgba(95,208,138,0.35)",S.lineWidth=1,S.strokeRect(e+.5,t+.5,l-1,n-1)}else{const a=2,o=e+a,i=t+a,r=l-2*a,c=n-2*a;S.fillStyle="#2a2f3a",S.fillRect(o,i,r,c),S.strokeStyle="rgba(200,210,230,0.12)",S.lineWidth=1,S.beginPath(),S.moveTo(o+.5*r,i+2),S.lineTo(o+.5*r,i+c-2),S.stroke(),S.beginPath(),S.moveTo(o+2,i+.35*c),S.lineTo(o+r-2,i+.35*c),S.moveTo(o+2,i+.7*c),S.lineTo(o+r-2,i+.7*c),S.stroke(),S.fillStyle="#c7cedd",S.beginPath(),S.arc(o+1.5,i+.25*c,.8,0,2*Math.PI),S.arc(o+1.5,i+.55*c,.8,0,2*Math.PI),S.fill(),S.beginPath(),S.arc(o+r-2.2,i+.5*c,1,0,2*Math.PI),S.fill(),S.strokeStyle="rgba(95,208,138,0.35)",S.lineWidth=1,S.strokeRect(e+.5,t+.5,l-1,n-1)}S.restore()})(q.x,q.y,q.w,q.h,n);for(const e of O){const t=S.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);t.addColorStop(0,`rgba(30,35,50,${e.a})`),t.addColorStop(1,"rgba(30,35,50,0)"),S.fillStyle=t,S.fillRect(0,0,P,x)}for(const e of C)y(e,1);for(const e of L)y(e,0);for(const e of C)p(e);for(const e of L)m(e);for(const e of $)S.save(),S.globalAlpha=.25*Math.max(0,e.life),S.fillStyle="#bcd4ff",S.beginPath(),S.ellipse(e.x,e.y,1.2,1.2,0,0,2*Math.PI),S.fill(),S.restore();for(const e of E)e.t&&g(e);for(const e of F)S.save(),S.globalAlpha=.2*Math.max(0,e.life),S.strokeStyle="#8fa3c2",S.lineWidth=1,S.beginPath(),S.ellipse(e.x,e.y+1,4.5*(1-.6*e.life),1.2,0,0,2*Math.PI),S.stroke(),S.restore();for(const e of B){let t=.18*Math.max(0,e.life);h(e.x,e.y)&&(t*=1.8),S.save(),S.globalAlpha=t,S.fillStyle="#7b8aa1",S.beginPath(),S.ellipse(e.x,e.y+2,3.2,1.4,0,0,2*Math.PI),S.fill(),S.restore()}const a=s(G.x,G.y);((e,t,l,n,a,o,i)=>{function r(e,t){const a=Math.max(.12,t);S.fillStyle=n?"rgba(255,230,120,0.25)":"#ffe678";const o=s+("R"===l?1.2:-1.2);S.beginPath(),S.ellipse(o-1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),S.ellipse(o+1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),S.fill()}function c(){S.strokeStyle=n?"rgba(200,210,230,0.25)":"rgba(200,210,230,0.55)",S.lineWidth=1,S.beginPath(),S.moveTo(s-4,f),S.lineTo(s-8,f-1),S.moveTo(s-4,f+2),S.lineTo(s-8,f+2),S.moveTo(s+4,f),S.lineTo(s+8,f-1),S.moveTo(s+4,f+2),S.lineTo(s+8,f+2),S.stroke()}S.save(),S.globalAlpha=n?.7:1;const s=e+("R"===l?5:-5),f=t-6;if("sit"===o)S.strokeStyle="#11131a",S.lineWidth=2,S.beginPath(),S.arc(e-("R"===l?6:-6),t+6,6,.2*Math.PI,1.6*Math.PI),S.stroke(),S.fillStyle="#0b0d12",S.beginPath(),S.ellipse(e,t+2,7,9,0,0,2*Math.PI),S.fill(),S.beginPath(),S.arc(s,f-2,4,0,2*Math.PI),S.fill(),S.beginPath(),S.moveTo(s-3,f-4),S.lineTo(s-1,f-8),S.lineTo(s,f-4),S.closePath(),S.moveTo(s+3,f-4),S.lineTo(s+1,f-8),S.lineTo(s,f-4),S.closePath(),S.fill(),S.fillStyle="#0c0e14",S.beginPath(),S.arc(e-3,t+8,1.2,0,2*Math.PI),S.arc(e+3,t+8,1.2,0,2*Math.PI),S.fill(),r(0,i),c();else if("crouch"===o){const n=2*Math.sin(a*Math.PI)*("R"===l?1:-1);S.fillStyle="#0b0d12",S.beginPath(),S.ellipse(e,t+3,9,4.5,0,0,2*Math.PI),S.fill(),S.beginPath(),S.arc(e+("R"===l?6:-6),t-3,3.6,0,2*Math.PI),S.fill();const o=e+("R"===l?6:-6),s=t-3;S.beginPath(),S.moveTo(o-3,s-1),S.lineTo(o-1,s-4),S.lineTo(o,s-1),S.closePath(),S.moveTo(o+3,s-1),S.lineTo(o+1,s-4),S.lineTo(o,s-1),S.closePath(),S.fill(),S.strokeStyle="#11131a",S.lineWidth=2,S.beginPath();const f=e-("R"===l?10:-10),h=t+5;S.moveTo(f,h),S.bezierCurveTo(f-4,h-1+n,f-8,h+1+n,f-2,h+2+n),S.stroke();const u=.6*Math.sin(2*a);S.fillStyle="#0c0e14",S.beginPath(),S.arc(e-3,t+6-u,1,0,2*Math.PI),S.arc(e+3,t+6+u,1,0,2*Math.PI),S.arc(e-1,t+5+u,1,0,2*Math.PI),S.arc(e+1,t+5-u,1,0,2*Math.PI),S.fill(),r(.8,i),c()}else{const n=3*Math.sin(a*Math.PI)*("R"===l?1:-1);S.fillStyle="#0b0d12",S.beginPath(),S.ellipse(e,t+1,8,6,0,0,2*Math.PI),S.fill(),S.beginPath(),S.arc(s,f,4,0,2*Math.PI),S.fill(),S.beginPath(),S.moveTo(s-3,f-2),S.lineTo(s-1,f-6),S.lineTo(s,f-2),S.closePath(),S.moveTo(s+3,f-2),S.lineTo(s+1,f-6),S.lineTo(s,f-2),S.closePath(),S.fill(),S.strokeStyle="#11131a",S.lineWidth=2,S.beginPath();const o=e-("R"===l?9:-9),h=t+1;S.moveTo(o,h),S.bezierCurveTo(o-4,h-2+n,o-6,h-6+n,o-2,h-8+n),S.stroke();const u=1.2*Math.sin(2*a);S.fillStyle="#0c0e14",S.beginPath(),S.arc(e-3,t+6-u,1,0,2*Math.PI),S.arc(e+3,t+6+u,1,0,2*Math.PI),S.arc(e-1,t+5+u,1,0,2*Math.PI),S.arc(e+1,t+5-u,1,0,2*Math.PI),S.fill(),r(0,i),c()}S.restore()})(G.x,G.y,G.dir,a,G.step,G.state,G.blink),S.save(),S.strokeStyle="rgba(170,190,220,0.35)",S.lineWidth=.5,S.beginPath();for(const e of W)S.moveTo(e.x,e.y),S.lineTo(e.x-.03*e.vx,e.y-.03*e.vy-e.len);S.stroke(),S.restore();const o=document.getElementById("fishCount"),i=document.getElementById("levelCount"),r=document.getElementById("doorState");o&&(o.textContent=`${Y}/${X}`),i&&(i.textContent=`${R+1}/${LEVELS.length}`),r&&(r.textContent=n?"Tür geöffnet":"Tür geschlossen");const c=document.getElementById("tutorial");c&&TIPS[R]&&""!==TIPS[R].trim()?(c.innerHTML="<strong>Level "+(R+1)+": </strong>"+TIPS[R],c.style.opacity=1):(c.innerHTML="",c.style.opacity=0),D?T("#ffd166","Entdeckt!","R für Neustart"):H&&T("#5fd08a","Geschafft!","Alle Fische gesammelt – weiter in 1.2s (Taste N für sofort)")})(),requestAnimationFrame(e)})</script> 