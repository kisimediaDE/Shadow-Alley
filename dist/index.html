<!doctype html> <html lang="de"> <head> <meta charset="utf-8"> <meta content="width=device-width,initial-scale=1" name="viewport"> <title>Shadow Alley</title> <style>#hud,.hint{opacity:.8}#tutorial,.kbd{background:#0f1320}body,html{height:100%;margin:0;background:#0b0d12;color:#dbe0ea;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}.wrap{display:grid;place-items:center;height:100%;gap:12px}canvas{background:#121621;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.04)}.hint{font-size:14px}.kbd{padding:2px 6px;border:1px solid #384152;border-bottom-width:2px;border-radius:6px;color:#c7cee0}a{color:#9ec5ff;text-decoration:none}#hud{width:100%;text-align:center;font:14px system-ui,sans-serif;color:#dbe0ea;pointer-events:none;margin-bottom:4px}#tutorial{border:1px solid #384152;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.04);padding:12px;opacity:0}</style> </head> <body> <div class="wrap"> <div id="hud"> Level: <span class="kbd" id="levelCount"></span> · Fish: <span class="kbd" id="fishCount"></span> · <span id="doorState"></span> </div> <canvas aria-label="Shadow Alley" height="320" id="game" width="480"></canvas> <div class="hint" id="tutorial"></div> <div class="hint" id="levelSelectWrapper" style="margin-top:6px;text-align:center"> <label for="levelSelect">Select Level:</label> <select class="kbd" id="levelSelect" style="min-width:140px"></select> </div> <div class="hint"> Controls: <span class="kbd">WASD</span>/<span class="kbd">Arrows</span> · Restart: <span class="kbd">R</span> · Mute: <span class="kbd">M</span> </div> </div> <script>const LEVELS=["##############################\n#............f............x..#\n#..####....####.......####...#\n#..#..#................#.....#\n#..#..#................#.....#\n#..####................#.....#\n#............................#\n#.####..####..####..####.....#\n#............................#\n#............................#\n#..........####..............#\n#..........#..#..............#\n#..........#..#..............#\n#..####....####..####..####..#\n#..#..#..................#...#\n#..#..#..................#...#\n#..####..................#...#\n#c...........................#\n#..f.........................#\n##############################","##############################\n#....l.......f...............#\n#......####...........####...#\n#.....................#..#...#\n#.........####........#..#...#\n#.....................#..#...#\n#..##.........l.......####...#\n#............................#\n#............f...............#\n#..l.....####............l...#\n#........#..#..............###\n#.######.#..#...........#....#\n#........####...........#....#\n#.......................#....#\n#..............l........#....#\n#...........#...........#....#\n#...........#...........#....#\n#c..........#......f....#....#\n#...........#...........#.x..#\n##############################","##############################\n#....l..........f...l........#\n#............................#\n#.x.....####.................#\n#.......................####.#\n#...####......####...........#\n#........l........####.......#\n#.................#..#.......#\n#......f..........#..#.......#\n#.................####...l...#\n#............................#\n#....L......###...........f..#\n#.####........#..............#\n#.#..#........#..........#####\n#.#..#...................#...#\n#.####........L..........#...#\n#........................#...#\n#c.......................#...#\n#...................f....#...#\n##############################","##############################\n#...................s........#\n#............................#\n#.....####l...........#..###.#\n#l....#..#............#......#\n#.....####............#......#\n#.....................#......#\n#.....####...............###.#\n#........................#.#f#\n#.f.......s......L.......#.#.#\n#...........##...........###.#\n######.......................#\n#....#.......................#\n#....#.............s...s.....#\n######..........###......#####\n#.x.L...........#........#...#\n#.c......f......#s.......#...#\n#........s......#f.......#...#\n#...............#..l.....#...#\n##############################","##############################\n#........#..#...#............#\n#........#..#...#............#\n#l.......####...L.....l......#\n#........f...................#\n#........####.........s......#\n#............................#\n#.#......s...####.......##...#\n#.#...####......#.......##...#\n#x#L..#..#..s.c.#.......##..f#\n#.#...#..#......#.......##...#\n#.#...####......#.......##...#\n#........s...####.......##...#\n#............................#\n#........####.........s......#\n#........f...................#\n#........####...L............#\n#l.......#..#...#............#\n#........#..#...#.....l......#\n##############################","##############################\n#.........#...#..#.......#...#\n#.........#...#f.#.......#...#\n#f........#####..#########...#\n#.L.......s..............#...#\n#....###.......###.s.....#...#\n#..............#.#.......#...#\n#..............#.#.......#...#\n#l......####...###.......#####\n#................L.......s..c#\n#.....s###...............#####\n#####..###....###........#...#\n#...#.........#.#........#...#\n#...#f.l......#.#........#...#\n#...#..###....###........#...#\n#...#..#........f........#...#\n#...#..#l.......s#########...#\n#...#..###.......#.......#...#\n#...#...x#.......#.......#...#\n##############################","##############################\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n##############################","##############################\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n##############################","##############################\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n#............................#\n##############################"],TIPS=["Sammle alle Fische und gehe zur Tür.","Achte auf feste Lampen – bleib im Schatten, sammle alle Fische und zur Tür.","Bewegliche Wachen mit Lichtkegeln – Timing! Fische sammeln und zur Tür.","Nutze die Verstecke (bläuliche Patches), meide Lichtkegel, sammle alle Fische und zur Tür."]</script> <script>function e(){if(A){A.innerHTML="";for(let e=0;e<LEVELS.length;e++){const t=document.createElement("option");t.value=e,t.textContent=`Level ${e+1}`,e>L.unlocked&&(t.disabled=1),e===I&&(t.selected=1),A.appendChild(t)}}}function t(e,t,l){return Math.max(t,Math.min(l,0|e))}function l(){try{localStorage.setItem(w,JSON.stringify(L))}catch(e){}}function n(){const e=LEVELS.length-1,t=Math.min(I+1,e);L.unlocked<t&&(L.unlocked=t,l())}function a(e){V.length=C.length=E.length=q.length=G.length=0,j=0,Q=0,H=0,z=0,e.split("\n").forEach((e,t)=>{for(let l=0;l<e.length;l++){const n=e[l],a=l*R,o=t*R;if("#"==n)V.push({x:a,y:o,w:R,h:R});else if("s"==n)C.push({x:a,y:o,w:R,h:R,glowIntensity:0});else if("l"==n)E.push({x:a+8,y:o+8,range:120,fov:Math.PI/3,angle:0,offX:10,offY:-11});else if("L"==n){const e=["#cc4455","#4aa3ff","#7bd389","#f2b134","#d45ed4","#ff8c00","#88cfff","#00bfff","#3cb371"],t=e[Math.floor(Math.random()*e.length)];q.push({x:a+8,y:o+8,range:160,fov:Math.PI/2,angle:0,dir:1,sweep:.9,accent:t})}else"f"==n?G.push({x:a+8,y:o+8,t:1,dir:.5>Math.random()?0:Math.PI,p:6.28*Math.random(),anim:0,cycle:1.5+3*Math.random()}):"x"==n?B={x:a,y:o,w:R,h:R}:"c"==n&&(W.x=a+8,W.y=o+8)}}),D=G.length}function o(){n();const t=LEVELS.length-1;I=t>I?Math.min(L.unlocked,t):t,L.current=I,l(),a(LEVELS[I]),Z=0,ee=0,H=0,Q=0,_=null,e(),g()}function i(e,t,l){return t>e?t:e>l?l:e}function r(e,t,l){return!(e<l.x||e>l.x+l.w||t<l.y||t>l.y+l.h)}function c(e,t,l){for(let n=0;n<l.length;n++)if(r(e,t,l[n]))return 1;return 0}function f(e,t){return c(e,t,C)}function s(e,t,l,n,a,o,i){const r=e-l,c=t-n;if(Math.hypot(r,c)>i)return 0;const x=Math.atan2(c,r),f=Math.atan2(Math.sin(x-a),Math.cos(x-a));return Math.abs(f)<=.5*o}function h(e,t){for(const l of E)if(s(e,t,l.x+(l.offX||0),l.y+(l.offY||0),0,l.fov,l.range))return 1;for(const l of q)if(s(e,t,l.x,l.y,l.angle,l.fov,l.range))return 1;return 0}function u(){if(ne)return;ne=1,te=new(window.AudioContext||window.webkitAudioContext),le=te.createGain(),le.gain.value=ae?0:.7,le.connect(te.destination),oe=te.createGain(),oe.gain.value=.05,se=te.createStereoPanner(),se.pan.value=0,oe.connect(se).connect(le);const e=d(1),t=te.createBiquadFilter();t.type="lowpass",t.frequency.value=700,t.Q.value=1e-4;const l=te.createBiquadFilter();l.type="lowshelf",l.frequency.value=180,l.gain.value=8;const n=te.createBiquadFilter();n.type="highshelf",n.frequency.value=1500,n.gain.value=-24;const a=te.createGain();a.gain.value=.9,e.connect(t).connect(l).connect(n).connect(a).connect(oe);const o=d(1),i=te.createBiquadFilter();i.type="bandpass",i.frequency.value=900,i.Q.value=.8;const r=te.createBiquadFilter();r.type="highshelf",r.frequency.value=1500,r.gain.value=-12;const c=te.createGain();c.gain.value=.35,o.connect(i).connect(r).connect(c).connect(oe),ie=te.createOscillator(),ie.frequency.value=.5,re=te.createGain(),re.gain.value=.04,ie.connect(re).connect(oe.gain),ce=te.createOscillator(),ce.frequency.value=.12,fe=te.createGain(),fe.gain.value=.18,ce.connect(fe).connect(se.pan);const x=te.currentTime;e.start(x),o.start(x),ie.start(x),ce.start(x),(()=>{if(!te||he)return;de=te.createGain(),de.gain.value=.05,ue=te.createGain(),ue.gain.value=0,he=te.createOscillator(),he.type="triangle",he.frequency.value=440,he.connect(ue).connect(de).connect(le);const e=te.currentTime;he.start(e);const t=[440,523.25,587.33,659.25,783.99,880];!function e(){!function(){if(!te)return;const e=te.currentTime;ge=(()=>{if(.72>Math.random()){const e=[-1,0,1][Math.floor(3*Math.random())];let l=ge+e;return l=Math.max(0,Math.min(t.length-1,l)),l}return Math.floor(Math.random()*t.length)})();const l=t[ge]*(.08>Math.random()?.5:1);he.frequency.cancelScheduledValues(e),he.frequency.setValueAtTime(he.frequency.value,e),he.frequency.exponentialRampToValueAtTime(Math.max(60,l),e+.12),ue.gain.cancelScheduledValues(e),ue.gain.setValueAtTime(0,e),ue.gain.linearRampToValueAtTime(.12,e+.04),ue.gain.exponentialRampToValueAtTime(1e-4,e+.35)}();const l=.6+.2*Math.random();ye=setTimeout(e,1e3*l)}()})()}function d(e=0){const t=(te||new(window.AudioContext||window.webkitAudioContext)).createBuffer(1,Math.floor(44100),44100),l=t.getChannelData(0);for(let e=0;e<l.length;e++)l[e]=.6*(2*Math.random()-1);const n=te.createBufferSource();return n.buffer=t,n.loop=!!e,n}function y(){te&&setTimeout(()=>{te.suspend()},500)}function g(){te&&setTimeout(()=>{te.resume()},500)}function m(e,t){const l=e.range,n=e.fov,a=t?0:e.angle,o=t&&null!=e.offX?e.x+e.offX:e.x,i=t&&null!=e.offY?e.y+e.offY:e.y,r=a-n/2,c=a+n/2,f=x.createRadialGradient(o,i,8,o,i,l);f.addColorStop(0,"rgba(255,220,120,0.45)"),f.addColorStop(.7,"rgba(255,210,110,0.18)"),f.addColorStop(1,"rgba(255,200,100,0.0)"),x.save(),x.fillStyle=f,x.beginPath(),x.moveTo(o,i),x.lineTo(o+Math.cos(r)*l,i+Math.sin(r)*l),x.arc(o,i,l,r,c),x.closePath(),x.fill(),x.restore()}function p(e){const{x:t,y:l,dir:n,p:a,anim:o}=e,i=K,r=1+1.2*o,c=Math.sin(7*i+(a||0))*(.7*r),f=Math.sin(1.6*i+(a||0))*(.9*(.5+.5*r)),s=Math.sin(2.2*i+1.3*(a||0))*(.05*r),h=1+s,u=1-.7*s;x.save();const d=x.createRadialGradient(t,l,0,t,l,10);d.addColorStop(0,"rgba(255,214,102,0.16)"),d.addColorStop(1,"rgba(255,214,102,0)"),x.fillStyle=d,x.fillRect(t-12,l-12,24,24),x.restore(),x.save(),x.translate(t,l+f);const y=n&&.001>Math.abs(n-Math.PI);x.scale((y?-1:1)*h,u),x.fillStyle="#ffd166",x.beginPath(),x.ellipse(0,0,9*.6,3,0,0,2*Math.PI),x.fill(),x.strokeStyle="rgba(50,60,80,0.35)",x.lineWidth=.8,x.stroke(),x.fillStyle="#eab54a",x.beginPath(),x.moveTo(.6*-9,0),x.lineTo(.6*-9-3.5,2+c),x.lineTo(.6*-9-3.5,-2-c),x.closePath(),x.fill(),x.fillStyle="#f6c255",x.save(),x.translate(1.2,-2.25),x.rotate(.1*c),x.beginPath(),x.moveTo(-2.2,0),x.lineTo(1.8,-3),x.lineTo(3.2,0),x.closePath(),x.fill(),x.restore(),o>.05&&(x.fillStyle="rgba(80,70,60,0.25)",x.beginPath(),x.ellipse(-1.5,.2,1.2*(1+.6*o),1,0,0,2*Math.PI),x.fill()),x.fillStyle="#4b4f5a",x.beginPath(),x.arc(9*.28,-.4,.7,0,2*Math.PI),x.fill(),x.globalAlpha=.28+.22*o,x.fillStyle="#ffffff",x.beginPath(),x.ellipse(.45,-1.25,2,1,0,0,2*Math.PI),x.fill(),x.globalAlpha=1,x.restore()}function b(e){const{x:t,y:l,angle:n,accent:a}=e,o=K;x.save(),x.translate(t,l),x.rotate(n);const i=.72;x.fillStyle="rgba(0,0,0,0.35)",x.beginPath(),x.ellipse(0,6*i,8*i,2.6*i,0,0,2*Math.PI),x.fill();const r="#4f4436",c=a||"#cc4455";x.fillStyle=r,x.beginPath(),x.ellipse(-1*i,0,9*i,6*i,0,0,2*Math.PI),x.fill(),x.fillStyle="#3f362c",x.beginPath(),x.ellipse(-2*i,2.6*i,4.608,2.6*i,0,0,2*Math.PI),x.fill();const f=3.8*i,s=2.5*i;x.fillStyle=r,x.beginPath(),x.ellipse(f,-.72,2.592,s,0,0,2*Math.PI),x.fill(),x.strokeStyle=c,x.lineWidth=.864,x.beginPath(),x.ellipse(f,-.648,2.4624,.99,0,0,2*Math.PI),x.stroke(),x.fillStyle="#ffd166",x.beginPath(),x.arc(f-.2*2.592,.72,.648,0,2*Math.PI),x.fill(),x.fillStyle=r,x.beginPath(),x.ellipse(7.6*i,-1.584,3.312,2.592,0,0,2*Math.PI),x.fill(),x.fillStyle="#c7ab92",x.beginPath(),x.moveTo(6.912,-3*i),x.lineTo(9.072,-2.016),x.lineTo(9.072,-.864),x.lineTo(6.912,-1.3*i),x.closePath(),x.fill(),x.beginPath(),x.ellipse(12.7*i,-2*i,1*i,1*i,0,0,2*Math.PI),x.fill(),x.fillStyle="#1b1f28",x.beginPath(),x.arc(9.648,-2*i,.54,0,2*Math.PI),x.fill();const h=.18*Math.sin(5.2*o)*i;x.fillStyle=r,x.beginPath(),x.moveTo(4.752,-5.2*i),x.lineTo(5.616,-5.688-h),x.lineTo(9*i,-5*i),x.closePath(),x.fill(),x.globalAlpha=.85,x.beginPath(),x.moveTo(4.104,-3.528),x.lineTo(4.968,-7.3*i+.6*h),x.lineTo(7.6*i,-3.384),x.closePath(),x.fill(),x.globalAlpha=1,x.fillStyle="#12151b",x.beginPath(),x.arc(7.056,-3*i,.432,0,2*Math.PI),x.fill();const u=2.304,d=Math.sin(4.8*o);x.fillStyle=r,x.fillRect(3.168,u+-.2*d*i,1.152,2.592),x.fillRect(6.2*i,u+.2*d*i,1.152,2.592),x.fillRect(-3.888,u+.2*d*i,1.296,3.8*i),x.fillRect(-2.448,u+-.2*d*i,1.296,3.8*i);const y=.5*Math.sin(9.5*o)*i;x.strokeStyle=r,x.lineWidth=2,x.beginPath(),x.moveTo(-9*i,-.432),x.quadraticCurveTo(-8.352,-4*i+y,-6.048,-4.896+y),x.stroke(),x.restore()}function T(e){const{x:t,y:l}=e;x.save(),x.fillStyle="rgba(0,0,0,0.25)",x.beginPath(),x.ellipse(t,l+8,6,2,0,0,2*Math.PI),x.fill(),x.fillStyle="#2a3140",x.fillRect(t-1,l-12,2,16),x.fillRect(t+0,l-10,8,2);const n=t+(e.offX??10),a=l+(e.offY??-11);x.fillStyle="#232a38",x.fillRect(n-5,a-3,10,6),x.fillStyle="#1d2330",x.fillRect(n-4,a-5,8,2),x.fillStyle="rgba(255,236,170,0.9)",x.fillRect(n-4,a-2,8,4),x.fillStyle="#1d2330",x.fillRect(n-1,a-6,2,1),x.fillStyle="#2a3140",x.fillRect(t-3,l+3,6,2);const o=n+2,i=a,r=x.createRadialGradient(o,i,0,o,i,12);r.addColorStop(0,"rgba(255,236,170,0.30)"),r.addColorStop(1,"rgba(255,236,170,0.0)"),x.fillStyle=r,x.fillRect(n-26,a-26,52,52),x.restore()}function M(e){function t(){return y=1e4*Math.sin(y),y-Math.floor(y)}const l=e.x,n=e.y,a=e.w,o=e.h,i=K||0;x.save(),x.fillStyle="rgba(8,14,24,0.78)",x.fillRect(l,n,a,o);const r=l+.5*a,c=n+.5*o,f=x.createRadialGradient(r,c,2,r,c,.75*Math.max(a,o));f.addColorStop(0,"rgba(0,0,0,0.38)"),f.addColorStop(.65,"rgba(0,0,0,0.2)"),f.addColorStop(1,"rgba(0,0,0,0)"),x.fillStyle=f,x.fillRect(l-8,n-8,a+16,o+16);let s=x.createLinearGradient(l,n,l,n+7);s.addColorStop(0,"rgba(0,0,0,0.65)"),s.addColorStop(1,"rgba(0,0,0,0.0)"),x.fillStyle=s,x.fillRect(l,n,a,7),s=x.createLinearGradient(l,n+o,l,n+o-7),s.addColorStop(0,"rgba(0,0,0,0.55)"),s.addColorStop(1,"rgba(0,0,0,0.0)"),x.fillStyle=s,x.fillRect(l,n+o-7,a,7),s=x.createLinearGradient(l,n,l+7,n),s.addColorStop(0,"rgba(0,0,0,0.6)"),s.addColorStop(1,"rgba(0,0,0,0.0)"),x.fillStyle=s,x.fillRect(l,n,7,o),s=x.createLinearGradient(l+a,n,l+a-7,n),s.addColorStop(0,"rgba(0,0,0,0.6)"),s.addColorStop(1,"rgba(0,0,0,0.0)"),x.fillStyle=s,x.fillRect(l+a-7,n,7,o),x.strokeStyle="rgba(120,170,220,0.12)",x.lineWidth=1,x.strokeRect(l+.5,n+.5,a-1,o-1),x.globalAlpha=.08,x.fillStyle="#5f6d85";const u=l/a|0,d=n/o|0;let y=1e4*Math.sin(91*(u+31)+57*(d+17)+.8*i);for(let e=0;8>e;e++){const e=l+Math.floor(t()*a),i=n+Math.floor(t()*o);x.fillRect(e,i,1,1)}x.globalAlpha=1;const g=l+.5*a,m=n+.5*o,p=h(g,m)?1:0;if("number"!=typeof e.glowIntensity&&(e.glowIntensity=0),e.glowIntensity+=.08*(p-e.glowIntensity),e.glowIntensity>.01){const t=.18*(.6+.4*(.5+.5*Math.sin(1.6*(K||0))))*e.glowIntensity,i=x.createRadialGradient(g,m,2,g,m,1.2*Math.max(a,o));i.addColorStop(0,`rgba(120,170,255,${t})`),i.addColorStop(1,"rgba(120,170,255,0)"),x.fillStyle=i,x.fillRect(l-12,n-12,a+24,o+24)}x.restore()}function S(e,t,l){x.fillStyle="rgba(0,0,0,0.6)",x.fillRect(0,0,v,k),x.textAlign="center",x.fillStyle=e,x.font="bold 24px system-ui, sans-serif",x.fillText(t,v/2,k/2-6),x.fillStyle="#dbe0ea",x.font="14px system-ui, sans-serif",x.fillText(l,v/2,k/2+16),x.textAlign="left"}const P=document.getElementById("game"),x=P.getContext("2d"),v=P.width,k=P.height,R=16;Math.floor(v/R),Math.floor(k/R);let I=0;const A=document.getElementById("levelSelect");A&&A.addEventListener("change",()=>{const t=parseInt(A.value,10);Number.isNaN(t)||t>L.unlocked||(I=t,L.current=t,l(),a(LEVELS[I]),Z=0,ee=0,H=0,Q=0,_=null),e()});const w="js13k_shadowalley_v1";let L={current:0,unlocked:0},V=[],C=[],E=[],q=[],G=[],B={x:v-32,y:16,w:R,h:R};const W={x:64,y:k-64,r:6,speed:1.7,vx:0,vy:0,dir:"R",step:0,state:"idle",idle:0,blink:1,blinkTimer:2,fpTimer:0,pawParity:0,db:0},F=[],O=[],N=[],$=[{x:80,y:60,dx:.06,dy:.02,r:90,a:.12},{x:240,y:140,dx:-.04,dy:.03,r:120,a:.1},{x:380,y:220,dx:.03,dy:-.05,r:100,a:.09}];let X=0;const Y=[];let D=0,j=0,H=0,Q=0,z=0;(()=>{try{const e=localStorage.getItem(w);if(e){const t=JSON.parse(e);"object"==typeof t&&t&&(L={current:0|t.current,unlocked:0|t.unlocked})}}catch(e){}const e=LEVELS.length-1;L.unlocked=t(L.unlocked,0,e),L.current=t(L.current,0,L.unlocked)})(),I=t(L.current,0,Math.max(0,Math.min(L.unlocked,LEVELS.length-1))),a(LEVELS[I]),e();const J=Object.create(null);addEventListener("keydown",t=>{J[t.key]=1,ne||u(),"m"!==t.key&&"M"!==t.key||(ae=!ae,le&&(le.gain.value=ae?0:.7)),"r"!==t.key&&"R"!==t.key||(z?(LEVELS.length,I=0,L.current=0,l(),a(LEVELS[I]),Z=0,ee=0,H=0,Q=0,z=0,_=null,e(),g()):(a(LEVELS[I]),Z=0,ee=0,W.vx=W.vy=0,z=0,L.current=I,l(),e(),g())),"n"!==t.key&&"N"!==t.key||!Q||o()}),addEventListener("keyup",e=>J[e.key]=0);let _=null,U=performance.now(),K=0,Z=0,ee=0,te=null,le=null,ne=0,ae=0,oe=null,ie=null,re=null,ce=null,fe=null,se=null,he=null,ue=null,de=null,ye=null,ge=0,me=0;const pe={collect(){if(!te)return;const e=te.currentTime,t=te.createGain();t.gain.setValueAtTime(0,e),t.gain.linearRampToValueAtTime(.25,e+.005),t.gain.exponentialRampToValueAtTime(1e-4,e+.18);const l=te.createOscillator();l.type="sine",l.frequency.setValueAtTime(880,e),l.frequency.exponentialRampToValueAtTime(1320,e+.12);const n=te.createOscillator();n.type="sine",n.frequency.setValueAtTime(660,e+.02),n.frequency.exponentialRampToValueAtTime(990,e+.18),l.connect(t),n.connect(t),t.connect(le),l.start(e),l.stop(e+.2),n.start(e+.02),n.stop(e+.22)},door(){if(!te)return;const e=te.currentTime,t=d(),l=te.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.2,e+.05),l.gain.exponentialRampToValueAtTime(1e-4,e+.6);const n=te.createBiquadFilter();n.type="bandpass",n.frequency.value=1200,n.Q.value=.8,t.connect(n).connect(l).connect(le),t.start(e),t.stop(e+.65);const a=te.createOscillator();a.type="sine",a.frequency.setValueAtTime(180,e),a.frequency.exponentialRampToValueAtTime(90,e+.5);const o=te.createGain();o.gain.setValueAtTime(0,e),o.gain.linearRampToValueAtTime(.12,e+.1),o.gain.exponentialRampToValueAtTime(1e-4,e+.6),a.connect(o).connect(le),a.start(e),a.stop(e+.65)},alert(){if(!te)return;const e=te.currentTime,t=te.createOscillator();t.type="square",t.frequency.setValueAtTime(340,e),t.frequency.exponentialRampToValueAtTime(160,e+.08);const l=te.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.28,e+.005),l.gain.exponentialRampToValueAtTime(1e-4,e+.15),t.connect(l).connect(le),t.start(e),t.stop(e+.16);const n=d(),a=te.createGain();a.gain.setValueAtTime(.2,e),a.gain.exponentialRampToValueAtTime(1e-4,e+.06),n.connect(a).connect(le),n.start(e),n.stop(e+.08)},footstep(e){if(!te)return;const t=te.currentTime,l=te.createBuffer(1,Math.floor(.05*te.sampleRate),te.sampleRate),n=l.getChannelData(0);for(let e=0;e<n.length;e++){const t=Math.exp(-e/180),l=.5*(2*Math.random()-1);n[e]=l*t}const a=te.createBufferSource();a.buffer=l;const o=te.createBiquadFilter();o.type="lowpass",o.frequency.value=1100+200*Math.random();const i=te.createBiquadFilter();i.type="highshelf",i.frequency.value=2e3,i.gain.value=-10;const r=te.createGain(),c=.16+.05*Math.random();r.gain.value=e?.55*c:c,a.connect(o).connect(i).connect(r).connect(le),a.start(t)},success(){if(!te)return;const e=te.currentTime;[523.25,659.25,783.99].forEach(t=>{const l=te.createOscillator();l.type="sine",l.frequency.value=t;const n=te.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.15,e+.02),n.gain.exponentialRampToValueAtTime(1e-4,e+.25),l.connect(n).connect(le),l.start(e),l.stop(e+.3)})}};requestAnimationFrame(function e(t){const a=(t-U)/1e3;U=t,K+=a,(e=>{if(H||Q||z)return Q&&null!=_&&K>=_?void o():void 0;let t=0,a=0;if((J.ArrowLeft||J.a||J.A)&&(t-=1),(J.ArrowRight||J.d||J.D)&&(t+=1),(J.ArrowUp||J.w||J.W)&&(a-=1),(J.ArrowDown||J.s||J.S)&&(a+=1),t||a){const e=Math.hypot(t,a);t/=e,a/=e}const x=60*W.speed*e;let h=i(W.x+t*x,W.r+1,v-W.r-1);c(h,W.y,V)||(W.x=h),h=i(W.y+a*x,W.r+1,k-W.r-1),c(W.x,h,V)||(W.y=h),-.01>t?W.dir="L":t>.01&&(W.dir="R"),t||a?W.step+=8*e:W.step=0;const u=!(!t&&!a),d=f(W.x,W.y);if(u?(W.idle=0,W.state=d?"crouch":"walk"):(W.idle+=e,d?W.state="crouch":W.idle>.8?W.state="sit":W.state="idle"),W.blinkTimer-=e,W.blinkTimer>0||(W.blink>.5?(W.blink=0,W.blinkTimer=.1):(W.blink=1,W.db?(W.db=0,W.blinkTimer=1.8+2.2*Math.random()):.25>Math.random()&&"walk"!==W.state?(W.db=1,W.blinkTimer=.2):W.blinkTimer=1.8+2.2*Math.random())),(t||a)&&(W.fpTimer-=e,0>=W.fpTimer)){const e=Math.hypot(t,a)||1,l=t/e,n=a/e,o=W.pawParity?1:-1,i=W.x-6*l+3*-n*o,r=W.y-6*n+3*l*o;if(F.push({x:i,y:r,life:1}),W.fpTimer=.14,W.pawParity^=1,ne&&te){const e=te.currentTime;if((t||a)&&e-me>.25){const t=f(W.x,W.y);pe.footstep(t),me=e}}}for(let t=F.length-1;t>=0;t--)F[t].life-=.35*e,F[t].life>0||F.splice(t,1);for(const t of G)if(t.t){if(t.cycle-=e,0>=t.cycle){t.anim=1,t.cycle=1.8+2.8*Math.random(),.2>Math.random()&&(t.dir=0===t.dir?Math.PI:0);for(let e=0;3>e;e++){const e=(0===t.dir?1:-1)*(3.5+Math.random()),l=1*Math.random()-.5;Y.push({x:t.x+e,y:t.y+l,vy:-20-15*Math.random(),life:.9})}}t.anim>0&&(t.anim=Math.max(0,t.anim-1.5*e))}for(let t=Y.length-1;t>=0;t--){const l=Y[t];l.y+=l.vy*e,l.life-=.7*e,l.life>0&&l.y>=0||Y.splice(t,1)}if(X-=e,0>=X){for(let e=0;3>e;e++){const e=Math.random()*v,t=-10-40*Math.random(),l=220+80*Math.random(),n=-60-40*Math.random();O.push({x:e,y:t,vx:n,vy:l,len:10+8*Math.random()})}X=.05/.3}for(let t=O.length-1;t>=0;t--){const l=O[t];l.x+=l.vx*e,l.y+=l.vy*e,l.y>k-18?(N.push({x:l.x,y:k-18,life:1}),O.splice(t,1)):(-20>l.x||l.x>v+20||l.y>k+20)&&O.splice(t,1)}for(let t=N.length-1;t>=0;t--)N[t].life-=1.8*e,N[t].life>0||N.splice(t,1);for(const e of $)e.x+=e.dx,e.y+=e.dy,e.x<-e.r?e.x=v+e.r:e.x>v+e.r&&(e.x=-e.r),e.y<-e.r?e.y=k+e.r:e.y>k+e.r&&(e.y=-e.r);for(const t of q)t.angle+=t.dir*t.sweep*e,t.angle>1&&(t.angle=1,t.dir=-1),-1>t.angle&&(t.angle=-1,t.dir=1);const y=f(W.x,W.y);let g=0;for(const e of E)if(s(W.x,W.y,e.x+(e.offX||0),e.y+(e.offY||0),0,e.fov,e.range)){g=1;break}if(!g)for(const e of q)if(s(W.x,W.y,e.x,e.y,e.angle,e.fov,e.range)){g=1;break}g&&!y&&(!H&&ne&&pe.alert(),H=1);for(const e of G)e.t&&8>Math.hypot(W.x-e.x,W.y-e.y)&&(e.t=0,j++,ne&&pe.collect());if(j!==D||Z||(ne&&pe.door(),Z=1),j===D&&r(W.x,W.y,B)&&!Q&&!z){const e=LEVELS.length-1;I===e?(z=1,Q=0,ne&&!ee&&(pe.success(),ee=1),n(),L.current=Math.min(L.unlocked,e),l()):(Q=1,ne&&!ee&&(pe.success(),ee=1),null==_&&(_=K+1.2),n(),L.current=Math.min(L.unlocked,LEVELS.length-1),l())}})(a),(()=>{const e=LEVELS.length-1;L.unlocked>e&&(L.unlocked=e),I>L.unlocked&&(I=L.unlocked),L.current!==I&&(L.current=I,l()),x.clearRect(0,0,v,k);const t=x.createLinearGradient(0,0,0,k);t.addColorStop(0,"#0f1420"),t.addColorStop(1,"#0b0e17"),x.fillStyle=t,x.fillRect(0,0,v,k),x.fillStyle="rgba(0,0,0,0.0)",x.fillRect(0,0,v,k),x.fillStyle="#0b0d12";for(const e of V)x.fillRect(e.x,e.y,e.w,e.h);for(const e of C)M(e);const n=j===D;((e,t,l,n,a)=>{const o=e+l/2,i=t+n/2;if(x.save(),x.fillStyle="#0b0d12",x.fillRect(e,t,l,n),x.fillStyle="#141a22",x.fillRect(e+1,t+1,l-2,n-2),a){const a=2,r=e+a,c=t+a,f=l-2*a,s=n-2*a;x.fillStyle="#0a0f14",x.fillRect(r,c,f,s);const h=x.createRadialGradient(o,i,2,o,i,Math.max(l,n));h.addColorStop(0,"rgba(95,208,138,0.35)"),h.addColorStop(1,"rgba(95,208,138,0)"),x.fillStyle=h,x.fillRect(e-8,t-8,l+16,n+16),x.fillStyle="rgba(95,208,138,0.22)",x.beginPath();const u=o-.25*f,d=o+.25*f;x.moveTo(u,t+n),x.lineTo(d,t+n),x.lineTo(d+4,t+n+5),x.lineTo(u-4,t+n+5),x.closePath(),x.fill(),x.fillStyle="#23323b",x.strokeStyle="rgba(200,210,230,0.1)",x.lineWidth=1,x.beginPath();const y=r+.15*f,g=c+1;x.moveTo(y,g),x.lineTo(y+.55*f,g+.1*s),x.lineTo(y+.55*f,g+s-1),x.lineTo(y,g+s-2),x.closePath(),x.fill(),x.stroke();const m=.5*(Math.sin(3*K)+1),p=Math.max(1.5,3+3*m);x.fillStyle="#5fd08a",x.fillRect(o-p/2,c+2,p,s-4),x.strokeStyle="rgba(95,208,138,0.35)",x.lineWidth=1,x.strokeRect(e+.5,t+.5,l-1,n-1)}else{const a=2,o=e+a,i=t+a,r=l-2*a,c=n-2*a;x.fillStyle="#2a2f3a",x.fillRect(o,i,r,c),x.strokeStyle="rgba(200,210,230,0.12)",x.lineWidth=1,x.beginPath(),x.moveTo(o+.5*r,i+2),x.lineTo(o+.5*r,i+c-2),x.stroke(),x.beginPath(),x.moveTo(o+2,i+.35*c),x.lineTo(o+r-2,i+.35*c),x.moveTo(o+2,i+.7*c),x.lineTo(o+r-2,i+.7*c),x.stroke(),x.fillStyle="#c7cedd",x.beginPath(),x.arc(o+1.5,i+.25*c,.8,0,2*Math.PI),x.arc(o+1.5,i+.55*c,.8,0,2*Math.PI),x.fill(),x.beginPath(),x.arc(o+r-2.2,i+.5*c,1,0,2*Math.PI),x.fill(),x.strokeStyle="rgba(95,208,138,0.35)",x.lineWidth=1,x.strokeRect(e+.5,t+.5,l-1,n-1)}x.restore()})(B.x,B.y,B.w,B.h,n);for(const e of $){const t=x.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);t.addColorStop(0,`rgba(30,35,50,${e.a})`),t.addColorStop(1,"rgba(30,35,50,0)"),x.fillStyle=t,x.fillRect(0,0,v,k)}for(const e of E)m(e,1);for(const e of q)m(e,0);for(const e of E)T(e);for(const e of q)b(e);for(const e of Y)x.save(),x.globalAlpha=.25*Math.max(0,e.life),x.fillStyle="#bcd4ff",x.beginPath(),x.ellipse(e.x,e.y,1.2,1.2,0,0,2*Math.PI),x.fill(),x.restore();for(const e of G)e.t&&p(e);for(const e of N)x.save(),x.globalAlpha=.2*Math.max(0,e.life),x.strokeStyle="#8fa3c2",x.lineWidth=1,x.beginPath(),x.ellipse(e.x,e.y+1,4.5*(1-.6*e.life),1.2,0,0,2*Math.PI),x.stroke(),x.restore();for(const e of F){let t=.18*Math.max(0,e.life);h(e.x,e.y)&&(t*=1.8),x.save(),x.globalAlpha=t,x.fillStyle="#7b8aa1",x.beginPath(),x.ellipse(e.x,e.y+2,3.2,1.4,0,0,2*Math.PI),x.fill(),x.restore()}const a=f(W.x,W.y);((e,t,l,n,a,o,i)=>{function r(e,t){const a=Math.max(.12,t);x.fillStyle=n?"rgba(255,230,120,0.25)":"#ffe678";const o=f+("R"===l?1.2:-1.2);x.beginPath(),x.ellipse(o-1.5,s-.5+(e||0),.9,.9*a,0,0,2*Math.PI),x.ellipse(o+1.5,s-.5+(e||0),.9,.9*a,0,0,2*Math.PI),x.fill()}function c(){x.strokeStyle=n?"rgba(200,210,230,0.25)":"rgba(200,210,230,0.55)",x.lineWidth=1,x.beginPath(),x.moveTo(f-4,s),x.lineTo(f-8,s-1),x.moveTo(f-4,s+2),x.lineTo(f-8,s+2),x.moveTo(f+4,s),x.lineTo(f+8,s-1),x.moveTo(f+4,s+2),x.lineTo(f+8,s+2),x.stroke()}x.save(),x.globalAlpha=n?.7:1;const f=e+("R"===l?5:-5),s=t-6;if("sit"===o)x.strokeStyle="#11131a",x.lineWidth=2,x.beginPath(),x.arc(e-("R"===l?6:-6),t+6,6,.2*Math.PI,1.6*Math.PI),x.stroke(),x.fillStyle="#0b0d12",x.beginPath(),x.ellipse(e,t+2,7,9,0,0,2*Math.PI),x.fill(),x.beginPath(),x.arc(f,s-2,4,0,2*Math.PI),x.fill(),x.beginPath(),x.moveTo(f-3,s-4),x.lineTo(f-1,s-8),x.lineTo(f,s-4),x.closePath(),x.moveTo(f+3,s-4),x.lineTo(f+1,s-8),x.lineTo(f,s-4),x.closePath(),x.fill(),x.fillStyle="#0c0e14",x.beginPath(),x.arc(e-3,t+8,1.2,0,2*Math.PI),x.arc(e+3,t+8,1.2,0,2*Math.PI),x.fill(),r(0,i),c();else if("crouch"===o){const n=2*Math.sin(a*Math.PI)*("R"===l?1:-1);x.fillStyle="#0b0d12",x.beginPath(),x.ellipse(e,t+3,9,4.5,0,0,2*Math.PI),x.fill(),x.beginPath(),x.arc(e+("R"===l?6:-6),t-3,3.6,0,2*Math.PI),x.fill();const o=e+("R"===l?6:-6),f=t-3;x.beginPath(),x.moveTo(o-3,f-1),x.lineTo(o-1,f-4),x.lineTo(o,f-1),x.closePath(),x.moveTo(o+3,f-1),x.lineTo(o+1,f-4),x.lineTo(o,f-1),x.closePath(),x.fill(),x.strokeStyle="#11131a",x.lineWidth=2,x.beginPath();const s=e-("R"===l?10:-10),h=t+5;x.moveTo(s,h),x.bezierCurveTo(s-4,h-1+n,s-8,h+1+n,s-2,h+2+n),x.stroke();const u=.6*Math.sin(2*a);x.fillStyle="#0c0e14",x.beginPath(),x.arc(e-3,t+6-u,1,0,2*Math.PI),x.arc(e+3,t+6+u,1,0,2*Math.PI),x.arc(e-1,t+5+u,1,0,2*Math.PI),x.arc(e+1,t+5-u,1,0,2*Math.PI),x.fill(),r(.8,i),c()}else{const n=3*Math.sin(a*Math.PI)*("R"===l?1:-1);x.fillStyle="#0b0d12",x.beginPath(),x.ellipse(e,t+1,8,6,0,0,2*Math.PI),x.fill(),x.beginPath(),x.arc(f,s,4,0,2*Math.PI),x.fill(),x.beginPath(),x.moveTo(f-3,s-2),x.lineTo(f-1,s-6),x.lineTo(f,s-2),x.closePath(),x.moveTo(f+3,s-2),x.lineTo(f+1,s-6),x.lineTo(f,s-2),x.closePath(),x.fill(),x.strokeStyle="#11131a",x.lineWidth=2,x.beginPath();const o=e-("R"===l?9:-9),h=t+1;x.moveTo(o,h),x.bezierCurveTo(o-4,h-2+n,o-6,h-6+n,o-2,h-8+n),x.stroke();const u=1.2*Math.sin(2*a);x.fillStyle="#0c0e14",x.beginPath(),x.arc(e-3,t+6-u,1,0,2*Math.PI),x.arc(e+3,t+6+u,1,0,2*Math.PI),x.arc(e-1,t+5+u,1,0,2*Math.PI),x.arc(e+1,t+5-u,1,0,2*Math.PI),x.fill(),r(0,i),c()}x.restore()})(W.x,W.y,W.dir,a,W.step,W.state,W.blink),x.save(),x.strokeStyle="rgba(170,190,220,0.35)",x.lineWidth=.5,x.beginPath();for(const e of O)x.moveTo(e.x,e.y),x.lineTo(e.x-.03*e.vx,e.y-.03*e.vy-e.len);x.stroke(),x.restore();const o=document.getElementById("fishCount"),i=document.getElementById("levelCount"),r=document.getElementById("doorState");o&&(o.textContent=`${j}/${D}`),i&&(i.textContent=`${I+1}/${LEVELS.length}`),r&&(r.textContent=n?"Tür geöffnet":"Tür geschlossen");const c=document.getElementById("tutorial");c&&TIPS[I]&&""!==TIPS[I].trim()?(c.innerHTML="<strong>Level "+(I+1)+": </strong>"+TIPS[I],c.style.opacity=1):(c.innerHTML="",c.style.opacity=0),H?(y(),S("#ffd166","Entdeckt!","R für Neustart")):Q?(y(),S("#5fd08a","Geschafft!","Alle Fische gesammelt – weiter in 1.2s (Taste N für sofort)")):z&&(y(),S("#9ec5ff","Thanks for playing!","Press R to play again from Level 1"))})(),requestAnimationFrame(e)})</script> 