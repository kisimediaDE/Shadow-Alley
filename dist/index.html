<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta content="width=device-width,initial-scale=1" name="viewport"> <title>Shadow Alley</title> <style>#hud,.hint{opacity:.8}#tutorial,.kbd{background:#0f1320}body,html{height:100%;margin:0;background:#0b0d12;color:#dbe0ea;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}.wrap{display:grid;place-items:center;height:100%;gap:12px}canvas{background:#121621;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.04)}.hint{font-size:14px}.kbd{padding:2px 6px;border:1px solid #384152;border-bottom-width:2px;border-radius:6px;color:#c7cee0}a{color:#9ec5ff;text-decoration:none}#hud{width:100%;text-align:center;font:14px system-ui,sans-serif;color:#dbe0ea;pointer-events:none;margin-bottom:4px}#tutorial{border:1px solid #384152;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.04);padding:12px;opacity:0}</style> </head> <body> <div class="wrap"> <div id="hud"> Level: <span class="kbd" id="levelCount"></span> Â· Fish: <span class="kbd" id="fishCount"></span> Â· <span id="doorState"></span> </div> <canvas aria-label="Shadow Alley" height="320" id="game" width="480"></canvas> <div class="hint" id="tutorial"></div> <div class="hint" id="levelSelectWrapper" style="margin-top:6px;text-align:center"> <label for="levelSelect">Select Level:</label> <select class="kbd" id="levelSelect" style="min-width:140px"></select> </div> <div class="hint"> Controls: <span class="kbd">WASD</span>/<span class="kbd">Arrows</span> Â· Restart: <span class="kbd">R</span> Â· Mute: <span class="kbd">M</span> </div> </div> <script>const LEVELS=["##############################\n#............f............x..#\n#..####....####.......####...#\n#..#..#................#.....#\n#..#..#................#.....#\n#..####................#.....#\n#............................#\n#.####..####..####..####.....#\n#............................#\n#............................#\n#..........####..............#\n#..........#..#..............#\n#..........#..#..............#\n#..####....####..####..####..#\n#..#..#..................#...#\n#..#..#..................#...#\n#..####..................#...#\n#c...........................#\n#..f.........................#\n##############################","##############################\n#....l.......f...............#\n#......####...........####...#\n#.....................#..#...#\n#.........####........#..#...#\n#.....................#..#...#\n#..##.........l.......####...#\n#............................#\n#............f...............#\n#..l.....####............l...#\n#........#..#..............###\n#.######.#..#...........#....#\n#........####...........#....#\n#.......................#....#\n#..............l........#....#\n#...........#...........#....#\n#...........#...........#....#\n#c..........#......f....#....#\n#...........#...........#.x..#\n##############################","##############################\n#....l..........f...l........#\n#............................#\n#.x.....####.................#\n#.......................####.#\n#...####......####...........#\n#........l........####.......#\n#.................#..#.......#\n#......f..........#..#.......#\n#.................####...l...#\n#............................#\n#....L......###...........f..#\n#.####........#..............#\n#.#..#........#..........#####\n#.#..#...................#...#\n#.####........L..........#...#\n#........................#...#\n#c.......................#...#\n#...................f....#...#\n##############################","##############################\n#...................s........#\n#............................#\n#.....####l...........#..###.#\n#l....#..#............#......#\n#.....####............#......#\n#.....................#......#\n#.....####...............###.#\n#........................#.#f#\n#.f.......s......L.......#.#.#\n#...........##...........###.#\n######.......................#\n#....#.......................#\n#....#.............s...s.....#\n######..........###......#####\n#.x.L...........#........#...#\n#.c......f......#s.......#...#\n#........s......#f.......#...#\n#...............#..l.....#...#\n##############################","##############################\n#........#..#...#............#\n#........#..#...#............#\n#l.......####...L.....l......#\n#........f...................#\n#........####.........s......#\n#............................#\n#.#......s...####.......##...#\n#.#...####......#.......##...#\n#x#L..#..#..s.c.#.......##..f#\n#.#...#..#......#.......##...#\n#.#...####......#.......##...#\n#........s...####.......##...#\n#............................#\n#........####.........s......#\n#........f...................#\n#........####...L............#\n#l.......#..#...#............#\n#........#..#...#.....l......#\n##############################","##############################\n#.........#...#..#.......#...#\n#.........#...#f.#.......#...#\n#f........#####..#########...#\n#.L.......s..............#...#\n#....###.......###.s.....#...#\n#..............#.#.......#...#\n#..............#.#.......#...#\n#l......####...###.......#####\n#................L.......s..c#\n#.....s###...............#####\n#####..###....###........#...#\n#...#.........#.#........#...#\n#...#f.l......#.#........#...#\n#...#..###....###........#...#\n#...#..#........f........#...#\n#...#..#l.......s#########...#\n#...#..###.......#.......#...#\n#...#...x#.......#.......#...#\n##############################","##############################\n#...........................c#\n#.############################\n#.......s....................#\n#.L............f.............#\n############################.#\n#...#.....#.......f..........#\n#.#.#.....#......###.........#\n#.#.#.....l......#.#....######\n#.#s.f...........###.L..#....#\n#.#.#.....s.............#....#\n#.#.#..####.........###s#....#\n#.#.L..#..#...###.......#....#\n#.#.#..####.............######\n#.#.#........................#\n#.#.#...s....................#\n#.#.#......#...l......###....#\n#.#.#f.....#..###.....#.#....#\n#x#........#..........#.#..f.#\n##############################","##############################\n#........#...#f.........s...f#\n#........#...#s.......####...#\n#l.......#...#........#..#...#\n#...f....#...#........####...#\n#...####.#####L..............#\n#............................#\n#............................#\n#....................ssss....#\n#x...........................#\n#.........c......###..L......#\n#l.......###.................#\n#####........###.............#\n#...#......L.................#\n#...#........................#\n#...#..................####..#\n#...#.....#####........#..#..#\n#...#f....#...#........####..#\n#...#.....#...#.....s.......f#\n##############################","##############################\n#f.........###L....#.#.#...#f#\n#s...###...#.#.....#.#.#...#.#\n#....l.....###.....###.#...#.#\n#..###.......f.........#...#.#\n#....s.....#####.###...#...#.#\n####.......#...#.......#...#.#\n#..........#...#.......#####.#\n#x.........#####.............#\n#.........................####\n#L..........c....l........#..#\n#####......###............####\n#...#......#.#...............#\n#####......#.#.###.......##..#\n#..........###.......###.....#\n#.l..........................#\n#..##...................l##..#\n#s.....##..............####..#\n#f............L.......s.....f#\n##############################"],TIPS=["Collect all fish and head to the door.","Watch out for fixed lamps â€” stay in the shadows, collect all fish, then reach the door.","Moving guards with light cones â€” timing matters! Collect all fish and reach the door.","Use hiding spots (bluish patches), avoid light cones, collect all fish, and reach the door."]</script> <script>function e(){const e=Math.min(window.innerWidth/480,window.innerHeight/320,2);e!==k&&(k=e,x.width=480*e,x.height=320*e,v.setTransform(1,0,0,1,0,0),v.scale(e,e))}function t(){if(L){L.innerHTML="";for(let e=0;e<LEVELS.length;e++){const t=document.createElement("option");t.value=e,t.textContent=`Level ${e+1}`,e>G.unlocked&&(t.disabled=1),e===C&&(t.selected=1),L.appendChild(t)}}}function l(e,t,l){return Math.max(t,Math.min(l,0|e))}function n(){try{localStorage.setItem(q,JSON.stringify(G))}catch(e){}}function a(){const e=LEVELS.length-1,t=Math.min(C+1,e);G.unlocked<t&&(G.unlocked=t,n())}function o(e){B.length=W.length=O.length=F.length=D.length=0,_=0,K=0,U=0,Z=0,e.split("\n").forEach((e,t)=>{for(let l=0;l<e.length;l++){const n=e[l],a=l*A,o=t*A;if("#"==n)B.push({x:a,y:o,w:A,h:A});else if("s"==n)W.push({x:a,y:o,w:A,h:A,glowIntensity:0});else if("l"==n)O.push({x:a+8,y:o+8,range:120,fov:Math.PI/3,angle:0,offX:10,offY:-11});else if("L"==n){const e=["#cc4455","#4aa3ff","#7bd389","#f2b134","#d45ed4","#ff8c00","#88cfff","#00bfff","#3cb371"],t=e[Math.floor(Math.random()*e.length)];F.push({x:a+8,y:o+8,range:160,fov:Math.PI/2,angle:0,dir:1,sweep:.9,accent:t})}else"f"==n?D.push({x:a+8,y:o+8,t:1,dir:.5>Math.random()?0:Math.PI,p:6.28*Math.random(),anim:0,cycle:1.5+3*Math.random()}):"x"==n?Y={x:a,y:o,w:A,h:A}:"c"==n&&(N.x=a+8,N.y=o+8)}}),J=D.length}function i(){a();const e=LEVELS.length-1;C=e>C?Math.min(G.unlocked,e):e,G.current=C,n(),o(LEVELS[C]),oe=0,ie=0,U=0,K=0,le=null,t(),m()}function r(e,t,l){return t>e?t:e>l?l:e}function c(e,t,l){return!(e<l.x||e>l.x+l.w||t<l.y||t>l.y+l.h)}function s(e,t,l){for(let n=0;n<l.length;n++)if(c(e,t,l[n]))return 1;return 0}function f(e,t){return s(e,t,W)}function h(e,t,l,n,a,o,i){const r=e-l,v=t-n;if(Math.hypot(r,v)>i)return 0;const c=Math.atan2(v,r),s=Math.atan2(Math.sin(c-a),Math.cos(c-a));return Math.abs(s)<=.5*o}function d(e,t){for(const l of O)if(h(e,t,l.x+(l.offX||0),l.y+(l.offY||0),0,l.fov,l.range))return 1;for(const l of F)if(h(e,t,l.x,l.y,l.angle,l.fov,l.range))return 1;return 0}function u(){if(se)return;se=1,re=new(window.AudioContext||window.webkitAudioContext),ce=re.createGain(),ce.gain.value=fe?0:.7,ce.connect(re.destination),he=re.createGain(),he.gain.value=.05,me=re.createStereoPanner(),me.pan.value=0,he.connect(me).connect(ce);const e=y(1),t=re.createBiquadFilter();t.type="lowpass",t.frequency.value=700,t.Q.value=1e-4;const l=re.createBiquadFilter();l.type="lowshelf",l.frequency.value=180,l.gain.value=8;const n=re.createBiquadFilter();n.type="highshelf",n.frequency.value=1500,n.gain.value=-24;const a=re.createGain();a.gain.value=.9,e.connect(t).connect(l).connect(n).connect(a).connect(he);const o=y(1),i=re.createBiquadFilter();i.type="bandpass",i.frequency.value=900,i.Q.value=.8;const r=re.createBiquadFilter();r.type="highshelf",r.frequency.value=1500,r.gain.value=-12;const v=re.createGain();v.gain.value=.35,o.connect(i).connect(r).connect(v).connect(he),de=re.createOscillator(),de.frequency.value=.5,ue=re.createGain(),ue.gain.value=.04,de.connect(ue).connect(he.gain),ye=re.createOscillator(),ye.frequency.value=.12,ge=re.createGain(),ge.gain.value=.18,ye.connect(ge).connect(me.pan);const c=re.currentTime;e.start(c),o.start(c),de.start(c),ye.start(c),(()=>{if(!re||pe)return;Te=re.createGain(),Te.gain.value=.05,be=re.createGain(),be.gain.value=0,pe=re.createOscillator(),pe.type="triangle",pe.frequency.value=440,pe.connect(be).connect(Te).connect(ce);const e=re.currentTime;pe.start(e);const t=[440,523.25,587.33,659.25,783.99,880];!function e(){!function(){if(!re)return;const e=re.currentTime;Me=(()=>{if(.72>Math.random()){const e=[-1,0,1][Math.floor(3*Math.random())];let l=Me+e;return l=Math.max(0,Math.min(t.length-1,l)),l}return Math.floor(Math.random()*t.length)})();const l=t[Me]*(.08>Math.random()?.5:1);pe.frequency.cancelScheduledValues(e),pe.frequency.setValueAtTime(pe.frequency.value,e),pe.frequency.exponentialRampToValueAtTime(Math.max(60,l),e+.12),be.gain.cancelScheduledValues(e),be.gain.setValueAtTime(0,e),be.gain.linearRampToValueAtTime(.12,e+.04),be.gain.exponentialRampToValueAtTime(1e-4,e+.35)}();const l=.6+.2*Math.random();Se=setTimeout(e,1e3*l)}()})()}function y(e=0){const t=(re||new(window.AudioContext||window.webkitAudioContext)).createBuffer(1,Math.floor(44100),44100),l=t.getChannelData(0);for(let e=0;e<l.length;e++)l[e]=.6*(2*Math.random()-1);const n=re.createBufferSource();return n.buffer=t,n.loop=!!e,n}function g(){re&&setTimeout(()=>{re.suspend()},500)}function m(){re&&setTimeout(()=>{re.resume()},500)}function p(e,t){const l=e.range,n=e.fov,a=t?0:e.angle,o=t&&null!=e.offX?e.x+e.offX:e.x,i=t&&null!=e.offY?e.y+e.offY:e.y,r=a-n/2,c=a+n/2,s=v.createRadialGradient(o,i,8,o,i,l);s.addColorStop(0,"rgba(255,220,120,0.45)"),s.addColorStop(.7,"rgba(255,210,110,0.18)"),s.addColorStop(1,"rgba(255,200,100,0.0)"),v.save(),v.fillStyle=s,v.beginPath(),v.moveTo(o,i),v.lineTo(o+Math.cos(r)*l,i+Math.sin(r)*l),v.arc(o,i,l,r,c),v.closePath(),v.fill(),v.restore()}function b(e){const{x:t,y:l,dir:n,p:a,anim:o}=e,i=ae,r=1+1.2*o,c=Math.sin(7*i+(a||0))*(.7*r),s=Math.sin(1.6*i+(a||0))*(.9*(.5+.5*r)),f=Math.sin(2.2*i+1.3*(a||0))*(.05*r),h=1+f,d=1-.7*f;v.save();const u=v.createRadialGradient(t,l,0,t,l,10);u.addColorStop(0,"rgba(255,214,102,0.16)"),u.addColorStop(1,"rgba(255,214,102,0)"),v.fillStyle=u,v.fillRect(t-12,l-12,24,24),v.restore(),v.save(),v.translate(t,l+s);const y=n&&.001>Math.abs(n-Math.PI);v.scale((y?-1:1)*h,d),v.fillStyle="#ffd166",v.beginPath(),v.ellipse(0,0,9*.6,3,0,0,2*Math.PI),v.fill(),v.strokeStyle="rgba(50,60,80,0.35)",v.lineWidth=.8,v.stroke(),v.fillStyle="#eab54a",v.beginPath(),v.moveTo(.6*-9,0),v.lineTo(.6*-9-3.5,2+c),v.lineTo(.6*-9-3.5,-2-c),v.closePath(),v.fill(),v.fillStyle="#f6c255",v.save(),v.translate(1.2,-2.25),v.rotate(.1*c),v.beginPath(),v.moveTo(-2.2,0),v.lineTo(1.8,-3),v.lineTo(3.2,0),v.closePath(),v.fill(),v.restore(),o>.05&&(v.fillStyle="rgba(80,70,60,0.25)",v.beginPath(),v.ellipse(-1.5,.2,1.2*(1+.6*o),1,0,0,2*Math.PI),v.fill()),v.fillStyle="#4b4f5a",v.beginPath(),v.arc(9*.28,-.4,.7,0,2*Math.PI),v.fill(),v.globalAlpha=.28+.22*o,v.fillStyle="#ffffff",v.beginPath(),v.ellipse(.45,-1.25,2,1,0,0,2*Math.PI),v.fill(),v.globalAlpha=1,v.restore()}function T(e){const{x:t,y:l,angle:n,accent:a}=e,o=ae;v.save(),v.translate(t,l),v.rotate(n);const i=.72;v.fillStyle="rgba(0,0,0,0.35)",v.beginPath(),v.ellipse(0,6*i,8*i,2.6*i,0,0,2*Math.PI),v.fill();const r="#4f4436",c=a||"#cc4455";v.fillStyle=r,v.beginPath(),v.ellipse(-1*i,0,9*i,6*i,0,0,2*Math.PI),v.fill(),v.fillStyle="#3f362c",v.beginPath(),v.ellipse(-2*i,2.6*i,4.608,2.6*i,0,0,2*Math.PI),v.fill();const s=3.8*i,f=2.5*i;v.fillStyle=r,v.beginPath(),v.ellipse(s,-.72,2.592,f,0,0,2*Math.PI),v.fill(),v.strokeStyle=c,v.lineWidth=.864,v.beginPath(),v.ellipse(s,-.648,2.4624,.99,0,0,2*Math.PI),v.stroke(),v.fillStyle="#ffd166",v.beginPath(),v.arc(s-.2*2.592,.72,.648,0,2*Math.PI),v.fill(),v.fillStyle=r,v.beginPath(),v.ellipse(7.6*i,-1.584,3.312,2.592,0,0,2*Math.PI),v.fill(),v.fillStyle="#c7ab92",v.beginPath(),v.moveTo(6.912,-3*i),v.lineTo(9.072,-2.016),v.lineTo(9.072,-.864),v.lineTo(6.912,-1.3*i),v.closePath(),v.fill(),v.beginPath(),v.ellipse(12.7*i,-2*i,1*i,1*i,0,0,2*Math.PI),v.fill(),v.fillStyle="#1b1f28",v.beginPath(),v.arc(9.648,-2*i,.54,0,2*Math.PI),v.fill();const h=.18*Math.sin(5.2*o)*i;v.fillStyle=r,v.beginPath(),v.moveTo(4.752,-5.2*i),v.lineTo(5.616,-5.688-h),v.lineTo(9*i,-5*i),v.closePath(),v.fill(),v.globalAlpha=.85,v.beginPath(),v.moveTo(4.104,-3.528),v.lineTo(4.968,-7.3*i+.6*h),v.lineTo(7.6*i,-3.384),v.closePath(),v.fill(),v.globalAlpha=1,v.fillStyle="#12151b",v.beginPath(),v.arc(7.056,-3*i,.432,0,2*Math.PI),v.fill();const d=2.304,u=Math.sin(4.8*o);v.fillStyle=r,v.fillRect(3.168,d+-.2*u*i,1.152,2.592),v.fillRect(6.2*i,d+.2*u*i,1.152,2.592),v.fillRect(-3.888,d+.2*u*i,1.296,3.8*i),v.fillRect(-2.448,d+-.2*u*i,1.296,3.8*i);const y=.5*Math.sin(9.5*o)*i;v.strokeStyle=r,v.lineWidth=2,v.beginPath(),v.moveTo(-9*i,-.432),v.quadraticCurveTo(-8.352,-4*i+y,-6.048,-4.896+y),v.stroke(),v.shadowBlur=0,v.restore()}function S(e){const{x:t,y:l}=e;v.save(),v.fillStyle="rgba(0,0,0,0.25)",v.beginPath(),v.ellipse(t,l+8,6,2,0,0,2*Math.PI),v.fill(),v.fillStyle="#2a3140",v.fillRect(t-1,l-12,2,16),v.fillRect(t+0,l-10,8,2);const n=t+(e.offX??10),a=l+(e.offY??-11);v.fillStyle="#232a38",v.fillRect(n-5,a-3,10,6),v.fillStyle="#1d2330",v.fillRect(n-4,a-5,8,2),v.fillStyle="rgba(255,236,170,0.9)",v.fillRect(n-4,a-2,8,4),v.fillStyle="#1d2330",v.fillRect(n-1,a-6,2,1),v.fillStyle="#2a3140",v.fillRect(t-3,l+3,6,2);const o=n+2,i=a,r=v.createRadialGradient(o,i,0,o,i,12);r.addColorStop(0,"rgba(255,236,170,0.30)"),r.addColorStop(1,"rgba(255,236,170,0.0)"),v.fillStyle=r,v.fillRect(n-26,a-26,52,52),v.restore()}function M(e){function t(){return y=1e4*Math.sin(y),y-Math.floor(y)}const l=e.x,n=e.y,a=e.w,o=e.h,i=ae||0;v.save(),v.fillStyle="rgba(8,14,24,0.78)",v.fillRect(l,n,a,o);const r=l+.5*a,c=n+.5*o,s=v.createRadialGradient(r,c,2,r,c,.75*Math.max(a,o));s.addColorStop(0,"rgba(0,0,0,0.38)"),s.addColorStop(.65,"rgba(0,0,0,0.2)"),s.addColorStop(1,"rgba(0,0,0,0)"),v.fillStyle=s,v.fillRect(l-8,n-8,a+16,o+16);let f=v.createLinearGradient(l,n,l,n+7);f.addColorStop(0,"rgba(0,0,0,0.65)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),v.fillStyle=f,v.fillRect(l,n,a,7),f=v.createLinearGradient(l,n+o,l,n+o-7),f.addColorStop(0,"rgba(0,0,0,0.55)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),v.fillStyle=f,v.fillRect(l,n+o-7,a,7),f=v.createLinearGradient(l,n,l+7,n),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),v.fillStyle=f,v.fillRect(l,n,7,o),f=v.createLinearGradient(l+a,n,l+a-7,n),f.addColorStop(0,"rgba(0,0,0,0.6)"),f.addColorStop(1,"rgba(0,0,0,0.0)"),v.fillStyle=f,v.fillRect(l+a-7,n,7,o),v.strokeStyle="rgba(120,170,220,0.12)",v.lineWidth=1,v.strokeRect(l+.5,n+.5,a-1,o-1),v.globalAlpha=.08,v.fillStyle="#5f6d85";const h=l/a|0,u=n/o|0;let y=1e4*Math.sin(91*(h+31)+57*(u+17)+.8*i);for(let e=0;8>e;e++){const e=l+Math.floor(t()*a),i=n+Math.floor(t()*o);v.fillRect(e,i,1,1)}v.globalAlpha=1;const g=l+.5*a,m=n+.5*o,p=d(g,m)?1:0;if("number"!=typeof e.glowIntensity&&(e.glowIntensity=0),e.glowIntensity+=.08*(p-e.glowIntensity),e.glowIntensity>.01){const t=.18*(.6+.4*(.5+.5*Math.sin(1.6*(ae||0))))*e.glowIntensity,i=v.createRadialGradient(g,m,2,g,m,1.2*Math.max(a,o));i.addColorStop(0,`rgba(120,170,255,${t})`),i.addColorStop(1,"rgba(120,170,255,0)"),v.fillStyle=i,v.fillRect(l-12,n-12,a+24,o+24)}v.restore()}function P(e,t,l){v.fillStyle="rgba(0,0,0,0.6)",v.fillRect(0,0,I,w),v.textAlign="center",v.fillStyle=e,v.font="bold 24px system-ui, sans-serif",v.fillText(t,240,154),v.fillStyle="#dbe0ea",v.font="14px system-ui, sans-serif",v.fillText(l,240,176),v.textAlign="left"}const x=document.getElementById("game"),v=x.getContext("2d");let R,k=1;e(),addEventListener("resize",()=>{clearTimeout(R),R=setTimeout(e,100)});const I=480,w=320,A=16;Math.floor(30),Math.floor(20);let C=0;const L=document.getElementById("levelSelect"),E=document.getElementById("levelSelectWrapper"),V=document.getElementById("hud");L&&L.addEventListener("change",()=>{const e=parseInt(L.value,10);Number.isNaN(e)||e>G.unlocked||(C=e,G.current=e,n(),o(LEVELS[C]),oe=0,ie=0,U=0,K=0,le=null),t()});const q="js13k_shadowalley_v1";let G={current:0,unlocked:0},B=[],W=[],O=[],F=[],D=[],Y={x:448,y:16,w:A,h:A};const N={x:64,y:256,r:6,speed:1.7,vx:0,vy:0,dir:"R",step:0,state:"idle",idle:0,blink:1,blinkTimer:2,fpTimer:0,pawParity:0,db:0},X=[],$=[],H=[],j=[{x:80,y:60,dx:.06,dy:.02,r:90,a:.12},{x:240,y:140,dx:-.04,dy:.03,r:120,a:.1},{x:380,y:220,dx:.03,dy:-.05,r:100,a:.09}];let z=0;const Q=[];let J=0,_=0,U=0,K=0,Z=0,ee=1;(()=>{try{const e=localStorage.getItem(q);if(e){const t=JSON.parse(e);"object"==typeof t&&t&&(G={current:0|t.current,unlocked:0|t.unlocked})}}catch(e){}const e=LEVELS.length-1;G.unlocked=l(G.unlocked,0,e),G.current=l(G.current,0,G.unlocked)})(),C=l(G.current,0,Math.max(0,Math.min(G.unlocked,LEVELS.length-1))),o(LEVELS[C]),t();const te=Object.create(null);addEventListener("keydown",e=>{if(te[e.key]=1,ee&&("Enter"===e.key||" "===e.key||"Space"===e.code))return ee=0,u(),m(),E.style.opacity="1",void(V.style.opacity="1");se||u(),"m"!==e.key&&"M"!==e.key||(fe=!fe,ce&&(ce.gain.value=fe?0:.7)),"r"!==e.key&&"R"!==e.key||(Z?(LEVELS.length,C=0,G.current=0,n(),o(LEVELS[C]),oe=0,ie=0,U=0,K=0,Z=0,le=null,t(),m()):(o(LEVELS[C]),oe=0,ie=0,N.vx=N.vy=0,Z=0,G.current=C,n(),t(),m())),"n"!==e.key&&"N"!==e.key||!K||i()}),addEventListener("keyup",e=>te[e.key]=0);let le=null,ne=performance.now(),ae=0,oe=0,ie=0,re=null,ce=null,se=0,fe=0,he=null,de=null,ue=null,ye=null,ge=null,me=null,pe=null,be=null,Te=null,Se=null,Me=0,Pe=0;const xe={collect(){if(!re)return;const e=re.currentTime,t=re.createGain();t.gain.setValueAtTime(0,e),t.gain.linearRampToValueAtTime(.25,e+.005),t.gain.exponentialRampToValueAtTime(1e-4,e+.18);const l=re.createOscillator();l.type="sine",l.frequency.setValueAtTime(880,e),l.frequency.exponentialRampToValueAtTime(1320,e+.12);const n=re.createOscillator();n.type="sine",n.frequency.setValueAtTime(660,e+.02),n.frequency.exponentialRampToValueAtTime(990,e+.18),l.connect(t),n.connect(t),t.connect(ce),l.start(e),l.stop(e+.2),n.start(e+.02),n.stop(e+.22)},door(){if(!re)return;const e=re.currentTime,t=y(),l=re.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.2,e+.05),l.gain.exponentialRampToValueAtTime(1e-4,e+.6);const n=re.createBiquadFilter();n.type="bandpass",n.frequency.value=1200,n.Q.value=.8,t.connect(n).connect(l).connect(ce),t.start(e),t.stop(e+.65);const a=re.createOscillator();a.type="sine",a.frequency.setValueAtTime(180,e),a.frequency.exponentialRampToValueAtTime(90,e+.5);const o=re.createGain();o.gain.setValueAtTime(0,e),o.gain.linearRampToValueAtTime(.12,e+.1),o.gain.exponentialRampToValueAtTime(1e-4,e+.6),a.connect(o).connect(ce),a.start(e),a.stop(e+.65)},alert(){if(!re)return;const e=re.currentTime,t=re.createOscillator();t.type="square",t.frequency.setValueAtTime(340,e),t.frequency.exponentialRampToValueAtTime(160,e+.08);const l=re.createGain();l.gain.setValueAtTime(0,e),l.gain.linearRampToValueAtTime(.28,e+.005),l.gain.exponentialRampToValueAtTime(1e-4,e+.15),t.connect(l).connect(ce),t.start(e),t.stop(e+.16);const n=y(),a=re.createGain();a.gain.setValueAtTime(.2,e),a.gain.exponentialRampToValueAtTime(1e-4,e+.06),n.connect(a).connect(ce),n.start(e),n.stop(e+.08)},footstep(e){if(!re)return;const t=re.currentTime,l=re.createBuffer(1,Math.floor(.05*re.sampleRate),re.sampleRate),n=l.getChannelData(0);for(let e=0;e<n.length;e++){const t=Math.exp(-e/180),l=.5*(2*Math.random()-1);n[e]=l*t}const a=re.createBufferSource();a.buffer=l;const o=re.createBiquadFilter();o.type="lowpass",o.frequency.value=1100+200*Math.random();const i=re.createBiquadFilter();i.type="highshelf",i.frequency.value=2e3,i.gain.value=-10;const r=re.createGain(),v=.16+.05*Math.random();r.gain.value=e?.55*v:v,a.connect(o).connect(i).connect(r).connect(ce),a.start(t)},success(){if(!re)return;const e=re.currentTime;[523.25,659.25,783.99].forEach(t=>{const l=re.createOscillator();l.type="sine",l.frequency.value=t;const n=re.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.15,e+.02),n.gain.exponentialRampToValueAtTime(1e-4,e+.25),l.connect(n).connect(ce),l.start(e),l.stop(e+.3)})}};requestAnimationFrame(function e(t){const l=(t-ne)/1e3;ne=t,ae+=l,(e=>{if(ee)return;if(U||K||Z)return K&&null!=le&&ae>=le?void i():void 0;let t=0,l=0;if((te.ArrowLeft||te.a||te.A)&&(t-=1),(te.ArrowRight||te.d||te.D)&&(t+=1),(te.ArrowUp||te.w||te.W)&&(l-=1),(te.ArrowDown||te.s||te.S)&&(l+=1),t||l){const e=Math.hypot(t,l);t/=e,l/=e}const o=60*N.speed*e;let v=r(N.x+t*o,N.r+1,I-N.r-1);s(v,N.y,B)||(N.x=v),v=r(N.y+l*o,N.r+1,w-N.r-1),s(N.x,v,B)||(N.y=v),-.01>t?N.dir="L":t>.01&&(N.dir="R"),t||l?N.step+=8*e:N.step=0;const d=!(!t&&!l),u=f(N.x,N.y);if(d?(N.idle=0,N.state=u?"crouch":"walk"):(N.idle+=e,u?N.state="crouch":N.idle>.8?N.state="sit":N.state="idle"),N.blinkTimer-=e,N.blinkTimer>0||(N.blink>.5?(N.blink=0,N.blinkTimer=.1):(N.blink=1,N.db?(N.db=0,N.blinkTimer=1.8+2.2*Math.random()):.25>Math.random()&&"walk"!==N.state?(N.db=1,N.blinkTimer=.2):N.blinkTimer=1.8+2.2*Math.random())),(t||l)&&(N.fpTimer-=e,0>=N.fpTimer)){const e=Math.hypot(t,l)||1,n=t/e,a=l/e,o=N.pawParity?1:-1,i=N.x-6*n+3*-a*o,r=N.y-6*a+3*n*o;if(X.push({x:i,y:r,life:1}),N.fpTimer=.14,N.pawParity^=1,se&&re){const e=re.currentTime;if((t||l)&&e-Pe>.25){const t=f(N.x,N.y);xe.footstep(t),Pe=e}}}for(let t=X.length-1;t>=0;t--)X[t].life-=.35*e,X[t].life>0||X.splice(t,1);for(const t of D)if(t.t){if(t.cycle-=e,0>=t.cycle){t.anim=1,t.cycle=1.8+2.8*Math.random(),.2>Math.random()&&(t.dir=0===t.dir?Math.PI:0);for(let e=0;3>e;e++){const e=(0===t.dir?1:-1)*(3.5+Math.random()),l=1*Math.random()-.5;Q.push({x:t.x+e,y:t.y+l,vy:-20-15*Math.random(),life:.9})}}t.anim>0&&(t.anim=Math.max(0,t.anim-1.5*e))}for(let t=Q.length-1;t>=0;t--){const l=Q[t];l.y+=l.vy*e,l.life-=.7*e,l.life>0&&l.y>=0||Q.splice(t,1)}if(z-=e,0>=z){for(let e=0;3>e;e++){const e=Math.random()*I,t=-10-40*Math.random(),l=220+80*Math.random(),n=-60-40*Math.random();$.push({x:e,y:t,vx:n,vy:l,len:10+8*Math.random()})}z=.05/.3}for(let t=$.length-1;t>=0;t--){const l=$[t];l.x+=l.vx*e,l.y+=l.vy*e,l.y>302?(H.push({x:l.x,y:302,life:1}),$.splice(t,1)):(-20>l.x||l.x>500||l.y>340)&&$.splice(t,1)}for(let t=H.length-1;t>=0;t--)H[t].life-=1.8*e,H[t].life>0||H.splice(t,1);for(const e of j)e.x+=e.dx,e.y+=e.dy,e.x<-e.r?e.x=I+e.r:e.x>I+e.r&&(e.x=-e.r),e.y<-e.r?e.y=w+e.r:e.y>w+e.r&&(e.y=-e.r);for(const t of F)t.angle+=t.dir*t.sweep*e,t.angle>1&&(t.angle=1,t.dir=-1),-1>t.angle&&(t.angle=-1,t.dir=1);const y=f(N.x,N.y);let g=0;for(const e of O)if(h(N.x,N.y,e.x+(e.offX||0),e.y+(e.offY||0),0,e.fov,e.range)){g=1;break}if(!g)for(const e of F)if(h(N.x,N.y,e.x,e.y,e.angle,e.fov,e.range)){g=1;break}g&&!y&&(!U&&se&&xe.alert(),U=1);for(const e of D)e.t&&8>Math.hypot(N.x-e.x,N.y-e.y)&&(e.t=0,_++,se&&xe.collect());if(_!==J||oe||(se&&xe.door(),oe=1),_===J&&c(N.x,N.y,Y)&&!K&&!Z){const e=LEVELS.length-1;C===e?(Z=1,K=0,se&&!ie&&(xe.success(),ie=1),a(),G.current=Math.min(G.unlocked,e),n()):(K=1,se&&!ie&&(xe.success(),ie=1),null==le&&(le=ae+5),a(),G.current=Math.min(G.unlocked,LEVELS.length-1),n())}})(l),(()=>{const e=LEVELS.length-1;if(G.unlocked>e&&(G.unlocked=e),C>G.unlocked&&(C=G.unlocked),G.current!==C&&(G.current=C,n()),ee)return void(()=>{E.style.opacity="0",V.style.opacity="0",g(),v.clearRect(0,0,I,w);const e=v.createLinearGradient(0,0,0,w);e.addColorStop(0,"#0f1420"),e.addColorStop(1,"#0b0e17"),v.fillStyle=e,v.fillRect(0,0,I,w);const t=v.createRadialGradient(240,160,20,240,160,.7*Math.max(I,w));t.addColorStop(0,"rgba(0,0,0,0)"),t.addColorStop(1,"rgba(0,0,0,0.55)"),v.fillStyle=t,v.fillRect(0,0,I,w),v.textAlign="center",v.fillStyle="#dbe0ea",v.font="bold 28px system-ui, sans-serif",v.fillText("ðŸ¾ Shadow Alley ðŸ¾",240,72),v.save(),v.translate(240,100),v.fillStyle="#0b0d12",v.beginPath(),v.ellipse(0,8,22,12,0,0,2*Math.PI),v.fill(),v.beginPath(),v.arc(14,2,6,0,2*Math.PI),v.fill(),v.beginPath(),v.moveTo(10.5,-1.5),v.lineTo(12.5,-6.5),v.lineTo(14,-1.5),v.closePath(),v.moveTo(17.5,-1.5),v.lineTo(15.5,-6.5),v.lineTo(14,-1.5),v.closePath(),v.fill(),v.beginPath(),v.moveTo(-18,6),v.quadraticCurveTo(-28,-2,-12,-6),v.strokeStyle="#0b0d12",v.lineWidth=3,v.stroke(),v.restore(),v.fillStyle="#b7c3d6",v.font="13px system-ui, sans-serif";const l=["The city never sleeps. Rain falls, lamps flicker, and dogs guard the alleys.","You are a lone black cat, hungry and unseen.","Sneak through the night, gather fish to survive,","and escape through the glowing door before the light finds you."];let n=170;for(const e of l)v.fillText(e,240,n),n+=18;v.fillStyle="#5fd08a",v.font="bold 14px system-ui, sans-serif",v.fillText("Press Enter or Space to begin",240,284),v.textAlign="left"})();v.clearRect(0,0,I,w);const t=v.createLinearGradient(0,0,0,w);t.addColorStop(0,"#0f1420"),t.addColorStop(1,"#0b0e17"),v.fillStyle=t,v.fillRect(0,0,I,w),v.fillStyle="rgba(0,0,0,0.0)",v.fillRect(0,0,I,w),v.fillStyle="#0b0d12";for(const e of B)v.fillRect(e.x,e.y,e.w,e.h),v.fillStyle="rgba(95,110,130,0.08)",v.fillRect(e.x,e.y,e.w,1),v.fillRect(e.x,e.y,1,e.h),v.fillStyle="rgba(0,0,0,0.08)",v.fillRect(e.x,e.y+e.h-1,e.w,1),v.fillRect(e.x+e.w-1,e.y,1,e.h),v.fillStyle="#0b0d12";for(const e of W)M(e);const l=_===J;((e,t,l,n,a)=>{const o=e+l/2,i=t+n/2;if(v.save(),v.fillStyle="#0b0d12",v.fillRect(e,t,l,n),v.fillStyle="#141a22",v.fillRect(e+1,t+1,l-2,n-2),a){const a=2,r=e+a,c=t+a,s=l-2*a,f=n-2*a;v.fillStyle="#0a0f14",v.fillRect(r,c,s,f);const h=v.createRadialGradient(o,i,2,o,i,Math.max(l,n));h.addColorStop(0,"rgba(95,208,138,0.35)"),h.addColorStop(1,"rgba(95,208,138,0)"),v.fillStyle=h,v.fillRect(e-8,t-8,l+16,n+16),v.fillStyle="rgba(95,208,138,0.22)",v.beginPath();const d=o-.25*s,u=o+.25*s;v.moveTo(d,t+n),v.lineTo(u,t+n),v.lineTo(u+4,t+n+5),v.lineTo(d-4,t+n+5),v.closePath(),v.fill(),v.fillStyle="#23323b",v.strokeStyle="rgba(200,210,230,0.1)",v.lineWidth=1,v.beginPath();const y=r+.15*s,g=c+1;v.moveTo(y,g),v.lineTo(y+.55*s,g+.1*f),v.lineTo(y+.55*s,g+f-1),v.lineTo(y,g+f-2),v.closePath(),v.fill(),v.stroke();const m=.5*(Math.sin(3*ae)+1),p=Math.max(1.5,3+3*m);v.fillStyle="#5fd08a",v.fillRect(o-p/2,c+2,p,f-4),v.strokeStyle="rgba(95,208,138,0.35)",v.lineWidth=1,v.strokeRect(e+.5,t+.5,l-1,n-1)}else{const a=2,o=e+a,i=t+a,r=l-2*a,c=n-2*a;v.fillStyle="#2a2f3a",v.fillRect(o,i,r,c),v.strokeStyle="rgba(200,210,230,0.12)",v.lineWidth=1,v.beginPath(),v.moveTo(o+.5*r,i+2),v.lineTo(o+.5*r,i+c-2),v.stroke(),v.beginPath(),v.moveTo(o+2,i+.35*c),v.lineTo(o+r-2,i+.35*c),v.moveTo(o+2,i+.7*c),v.lineTo(o+r-2,i+.7*c),v.stroke(),v.fillStyle="#c7cedd",v.beginPath(),v.arc(o+1.5,i+.25*c,.8,0,2*Math.PI),v.arc(o+1.5,i+.55*c,.8,0,2*Math.PI),v.fill(),v.beginPath(),v.arc(o+r-2.2,i+.5*c,1,0,2*Math.PI),v.fill(),v.strokeStyle="rgba(95,208,138,0.35)",v.lineWidth=1,v.strokeRect(e+.5,t+.5,l-1,n-1)}v.restore()})(Y.x,Y.y,Y.w,Y.h,l);for(const e of j){const t=v.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);t.addColorStop(0,`rgba(30,35,50,${e.a})`),t.addColorStop(1,"rgba(30,35,50,0)"),v.fillStyle=t,v.fillRect(0,0,I,w)}for(const e of O)p(e,1);for(const e of F)p(e,0);for(const e of O)S(e);for(const e of F)T(e);for(const e of Q)v.save(),v.globalAlpha=.25*Math.max(0,e.life),v.fillStyle="#bcd4ff",v.beginPath(),v.ellipse(e.x,e.y,1.2,1.2,0,0,2*Math.PI),v.fill(),v.restore();for(const e of D)e.t&&b(e);for(const e of H)v.save(),v.globalAlpha=.2*Math.max(0,e.life),v.strokeStyle="#8fa3c2",v.lineWidth=1,v.beginPath(),v.ellipse(e.x,e.y+1,4.5*(1-.6*e.life),1.2,0,0,2*Math.PI),v.stroke(),v.restore();for(const e of X){let t=.18*Math.max(0,e.life);d(e.x,e.y)&&(t*=1.8),v.save(),v.globalAlpha=t,v.fillStyle="#7b8aa1",v.beginPath(),v.ellipse(e.x,e.y+2,3.2,1.4,0,0,2*Math.PI),v.fill(),v.restore()}const a=f(N.x,N.y);((e,t,l,n,a,o,i)=>{function r(e,t){const a=Math.max(.12,t);v.fillStyle=n?"rgba(255,230,120,0.25)":"#ffe678";const o=s+("R"===l?1.2:-1.2);v.beginPath(),v.ellipse(o-1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),v.ellipse(o+1.5,f-.5+(e||0),.9,.9*a,0,0,2*Math.PI),v.fill()}function c(){v.strokeStyle=n?"rgba(200,210,230,0.25)":"rgba(200,210,230,0.55)",v.lineWidth=1,v.beginPath(),v.moveTo(s-4,f),v.lineTo(s-8,f-1),v.moveTo(s-4,f+2),v.lineTo(s-8,f+2),v.moveTo(s+4,f),v.lineTo(s+8,f-1),v.moveTo(s+4,f+2),v.lineTo(s+8,f+2),v.stroke()}v.save(),v.globalAlpha=n?.7:1,v.shadowColor="rgba(255,255,255,0.4)",v.shadowBlur=3,v.shadowOffsetX=0,v.shadowOffsetY=0;const s=e+("R"===l?5:-5),f=t-6;if("sit"===o)v.strokeStyle="#11131a",v.lineWidth=2,v.beginPath(),v.arc(e-("R"===l?6:-6),t+6,6,.2*Math.PI,1.6*Math.PI),v.stroke(),v.fillStyle=n?"#0b0d12":"#151820",v.beginPath(),v.ellipse(e,t+2,7,9,0,0,2*Math.PI),v.fill(),v.beginPath(),v.arc(s,f-2,4,0,2*Math.PI),v.fill(),v.beginPath(),v.moveTo(s-3,f-4),v.lineTo(s-1,f-8),v.lineTo(s,f-4),v.closePath(),v.moveTo(s+3,f-4),v.lineTo(s+1,f-8),v.lineTo(s,f-4),v.closePath(),v.fill(),v.fillStyle="#0c0e14",v.beginPath(),v.arc(e-3,t+8,1.2,0,2*Math.PI),v.arc(e+3,t+8,1.2,0,2*Math.PI),v.fill(),r(0,i),c();else if("crouch"===o){const o=2*Math.sin(a*Math.PI)*("R"===l?1:-1);v.fillStyle=n?"#0b0d12":"#151820",v.beginPath(),v.ellipse(e,t+3,9,4.5,0,0,2*Math.PI),v.fill(),v.beginPath(),v.arc(e+("R"===l?6:-6),t-3,3.6,0,2*Math.PI),v.fill();const s=e+("R"===l?6:-6),f=t-3;v.beginPath(),v.moveTo(s-3,f-1),v.lineTo(s-1,f-4),v.lineTo(s,f-1),v.closePath(),v.moveTo(s+3,f-1),v.lineTo(s+1,f-4),v.lineTo(s,f-1),v.closePath(),v.fill(),v.strokeStyle="#11131a",v.lineWidth=2,v.beginPath();const h=e-("R"===l?10:-10),d=t+5;v.moveTo(h,d),v.bezierCurveTo(h-4,d-1+o,h-8,d+1+o,h-2,d+2+o),v.stroke();const u=.6*Math.sin(2*a);v.fillStyle="#0c0e14",v.beginPath(),v.arc(e-3,t+6-u,1,0,2*Math.PI),v.arc(e+3,t+6+u,1,0,2*Math.PI),v.arc(e-1,t+5+u,1,0,2*Math.PI),v.arc(e+1,t+5-u,1,0,2*Math.PI),v.fill(),r(.8,i),c()}else{const o=3*Math.sin(a*Math.PI)*("R"===l?1:-1);v.fillStyle=n?"#0b0d12":"#151820",v.beginPath(),v.ellipse(e,t+1,8,6,0,0,2*Math.PI),v.fill(),v.beginPath(),v.arc(s,f,4,0,2*Math.PI),v.fill(),v.beginPath(),v.moveTo(s-3,f-2),v.lineTo(s-1,f-6),v.lineTo(s,f-2),v.closePath(),v.moveTo(s+3,f-2),v.lineTo(s+1,f-6),v.lineTo(s,f-2),v.closePath(),v.fill(),v.strokeStyle="#11131a",v.lineWidth=2,v.beginPath();const h=e-("R"===l?9:-9),d=t+1;v.moveTo(h,d),v.bezierCurveTo(h-4,d-2+o,h-6,d-6+o,h-2,d-8+o),v.stroke();const u=1.2*Math.sin(2*a);v.fillStyle="#0c0e14",v.beginPath(),v.arc(e-3,t+6-u,1,0,2*Math.PI),v.arc(e+3,t+6+u,1,0,2*Math.PI),v.arc(e-1,t+5+u,1,0,2*Math.PI),v.arc(e+1,t+5-u,1,0,2*Math.PI),v.fill(),r(0,i),c()}v.restore()})(N.x,N.y,N.dir,a,N.step,N.state,N.blink),v.save(),v.strokeStyle="rgba(170,190,220,0.35)",v.lineWidth=.5,v.beginPath();for(const e of $)v.moveTo(e.x,e.y),v.lineTo(e.x-.03*e.vx,e.y-.03*e.vy-e.len);v.stroke(),v.restore();const o=document.getElementById("fishCount"),i=document.getElementById("levelCount"),r=document.getElementById("doorState");o&&(o.textContent=`${_}/${J}`),i&&(i.textContent=`${C+1}/${LEVELS.length}`),r&&(r.textContent=l?"Door open":"Door closed");const c=document.getElementById("tutorial");c&&TIPS[C]&&""!==TIPS[C].trim()?(c.innerHTML="<strong>Level "+(C+1)+": </strong>"+TIPS[C],c.style.opacity=1):(c.innerHTML="",c.style.opacity=0),U?(g(),P("#ffd166","Discovered!","R to Restart")):K?(g(),P("#5fd08a","Well Done!","All fish collected â€“ continuing in 5s (Press N for instant)")):Z&&(g(),P("#9ec5ff","Thanks for playing!","Press R to play again from Level 1"))})(),requestAnimationFrame(e)})</script> 